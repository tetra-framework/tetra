(()=>{var l={ws:null,pendingSubscriptions:new Map,offlineCallQueue:[],queueRetryTimer:null,debug(...e){window.__tetra_debug&&console.debug(...e)},init(){Alpine.magic("static",()=>l.$static),window.__tetra_useWebsockets&&this.ensureWebSocketConnection(),window.__tetra_messages&&(this.handleInitialMessages(window.__tetra_messages),delete window.__tetra_messages),Alpine.store("tetra_subscriptions")||Alpine.store("tetra_subscriptions",{}),this.initOnlineStatusStore(),this.initBrowserOnlineDetection()},initOnlineStatusStore(){if(this.onlineStatusInitialized)return;this.onlineStatusInitialized=!0,typeof Alpine<"u"&&(Alpine.store("tetraStatus")||Alpine.store("tetraStatus",{online:!0,lastActivity:Date.now(),update(){this.online=!0,this.lastActivity=Date.now()}}));let e=window.__tetra_onlineTimeout||1e4;this.offlineTimeout&&clearTimeout(this.offlineTimeout),this.offlineTimeout=setTimeout(()=>this.checkOnlineStatus(),e),document.addEventListener("tetra:websocket-connected",()=>this.updateOnlineStatus())},updateOnlineStatus(){if(typeof Alpine<"u"){let t=Alpine.store("tetraStatus");t&&t.update()}this.offlineTimeout&&clearTimeout(this.offlineTimeout);let e=window.__tetra_onlineTimeout||1e4;this.offlineTimeout=setTimeout(()=>this.checkOnlineStatus(),e),this.pingTimeout&&clearTimeout(this.pingTimeout)},checkOnlineStatus(){if(this.pingTimeout&&clearTimeout(this.pingTimeout),this.ws&&this.ws.readyState===WebSocket.OPEN){this.ws.send(JSON.stringify({protocol:"tetra-1.0",type:"ping"}));let e=window.__tetra_pingTimeout||5e3;this.pingTimeout=setTimeout(()=>this.setOfflineStatus(),e)}else this.setOfflineStatus()},setOfflineStatus(){if(typeof Alpine<"u"){let e=Alpine.store("tetraStatus");e&&e.online!==!1&&(e.online=!1,document.dispatchEvent(new CustomEvent("tetra:websocket-disconnected")))}},initBrowserOnlineDetection(){this.browserOnlineDetectionInitialized||(this.browserOnlineDetectionInitialized=!0,window.addEventListener("online",()=>{l.debug("Browser detected network online"),this.updateOnlineStatus(),window.__tetra_useWebsockets&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&this.ensureWebSocketConnection(),this.offlineCallQueue.length>0&&(l.debug(`Browser online event: processing ${this.offlineCallQueue.length} queued calls`),setTimeout(()=>{this.processOfflineCallQueue()},500))}),window.addEventListener("offline",()=>{l.debug("Browser detected network offline"),this.setOfflineStatus()}))},handleInitialMessages(e){e.forEach(t=>{document.dispatchEvent(new CustomEvent("tetra:new-message",{detail:t,bubbles:!0}))})},$static(){return e=>window.__tetra_staticRoot+e},ensureWebSocketConnection(){if(!this.ws||this.ws.readyState===WebSocket.CLOSED){console.log("Connecting to Tetra WebSocket...");let t=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws/tetra/`;this.ws=new WebSocket(t),this.ws.onerror=()=>{},this.ws.onopen=()=>{l.debug("Tetra WebSocket connected"),this.updateOnlineStatus(),document.dispatchEvent(new CustomEvent("tetra:websocket-connected")),this.pendingSubscriptions.forEach((r,n)=>{this.ws.send(JSON.stringify(r))}),this.pendingSubscriptions.clear(),this.processOfflineCallQueue()},this.ws.onmessage=r=>{this.updateOnlineStatus();let n=JSON.parse(r.data);if(n.type==="pong"){this.pingTimeout&&clearTimeout(this.pingTimeout);return}this.handleWebsocketMessage(n)},this.ws.onclose=()=>{console.log("Tetra WebSocket disconnected"),this.setOfflineStatus(),setTimeout(()=>{this.ensureWebSocketConnection()},3e3)}}return this.ws},_get_component_by_id(e){let t=document.querySelector(`[tetra-component-id="${e}"]`);if(t)return Alpine.$data(t)},_get_components_by_subscribe_group(e){let n=(Alpine.store("tetra_subscriptions")[e]||[]).map(s=>this._get_component_by_id(s)).filter(s=>!!s&&typeof s._removeComponent=="function");return[...new Set(n)]},handleWebsocketMessage(e){let t,r,n={};if(e.protocol!=="tetra-1.0"){console.warn("Invalid or missing Tetra protocol in WebSocket message:",e);return}switch(t=e.type,r=e.payload,n=e.metadata||{},t){case"subscription.response":this.handleSubscriptionResponse(r);break;case"notify":this.handleGroupNotify(r);break;case"component.data_changed":this.handleComponentDataChanged(r);break;case"component.removed":this.handleComponentRemoved(r);break;case"component.created":this.handleComponentCreated(r);break;default:console.warn("Unknown WebSocket message type:",t,":",e)}},handleSubscriptionResponse(e){switch(e.status){case"subscribed":l.debug("Subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-subscribed",{detail:{component:this,group:e.group}}));break;case"unsubscribed":l.debug("Subscription to group",e.group,"redacted successfully."),document.dispatchEvent(new CustomEvent("tetra:component-unsubscribed",{detail:{component:this,group:e.group}}));break;case"resubscribed":l.debug("Re-subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-resubscribed",{detail:{component:this,group:e.group}}));break;case"error":console.error("Error subscribing component",e.component_id,"to group",e.group,":",e.message),document.dispatchEvent(new CustomEvent("tetra:component-subscription-error",{detail:{component:this,group:e.group,message:e.message}}));break;default:l.debug("Subscription response faulty:",e)}},handleGroupNotify(e){let{group:t,event_name:r,data:n}=e;document.dispatchEvent(new CustomEvent(r,{detail:{data:n,group:t}}))},handleComponentDataChanged(e){let{group:t,data:r,sender_id:n,update:s}=e,i=this._get_components_by_subscribe_group(t);i.length===0&&document.querySelectorAll(`[tetra-subscription="${t}"]`).forEach(a=>{let d=Alpine.$data(a);d&&!i.includes(d)&&i.push(d)}),i.forEach(c=>{n&&c.__activeRequests&&c.__activeRequests.has(n)||(r&&Object.keys(r).length>0&&c._updateData(r),(s||!r||Object.keys(r).length===0)&&c._updateHtml().catch(a=>{console.error("Error updating component HTML:",a)}))})},handleComponentRemoved(e){let{type:t,group:r,component_id:n,target_group:s,sender_id:i}=e;if(n){let a=this._get_component_by_id(n);if(a&&a._removeComponent){if(i&&a.__activeRequests&&a.__activeRequests.has(i))return;a._removeComponent()}return}if(s){let a=this._get_components_by_subscribe_group(s);a.length===0&&document.querySelectorAll(`[tetra-subscription="${s}"]`).forEach(h=>{let o=Alpine.$data(h);o&&o._removeComponent&&o._removeComponent()}),a.forEach(d=>{if(d&&d._removeComponent){if(i&&d.__activeRequests&&d.__activeRequests.has(i))return;d._removeComponent()}});return}let c=this._get_components_by_subscribe_group(r);c.length===0&&document.querySelectorAll(`[tetra-subscription="${r}"]`).forEach(d=>{let h=Alpine.$data(d);h&&h._removeComponent&&h._removeComponent()}),c.forEach(a=>{if(a&&a._removeComponent){if(i&&a.__activeRequests&&a.__activeRequests.has(i))return;a._removeComponent()}})},handleComponentCreated(e){let{group:t,data:r,component_id:n,target_group:s,sender_id:i}=e;this._get_components_by_subscribe_group(t).forEach(a=>{i&&a.__activeRequests&&a.__activeRequests.has(i)||a._updateHtml().catch(d=>{console.error("Error updating component HTML after creation:",d)})})},scheduleQueueRetry(){this.queueRetryTimer&&clearTimeout(this.queueRetryTimer),this.offlineCallQueue.length>0&&(this.queueRetryTimer=setTimeout(()=>{this.processOfflineCallQueue()},2e3))},async processOfflineCallQueue(){if(this.offlineCallQueue.length===0)return;let e=this.offlineCallQueue.length;l.debug(`Processing ${e} queued calls from offline mode`),document.dispatchEvent(new CustomEvent("tetra:queue-processing-start",{detail:{queueLength:e}}));let t=[...this.offlineCallQueue];this.offlineCallQueue=[];for(let r of t)try{let{component:n,methodName:s,args:i,componentMetadata:c,preCallSnapshot:a,optimisticUpdate:d}=r,h=document.querySelector(`[tetra-component-id="${n.component_id}"]`),o=h?Alpine.$data(h):null;if(o&&n.key&&o.key!==n.key){l.debug(`Component ID ${n.component_id} found but key mismatch, searching by key: ${n.key}`);let f=document.querySelectorAll("[tetra-component-id]"),S=!1;for(let k of f){let $=Alpine.$data(k);if($&&$.key===n.key){h=k,o=$,S=!0,l.debug(`Found component by key ${n.key} with ID ${$.component_id}`);break}}S||(h=null,o=null)}let m=o&&(n.key===void 0||n.key===null||o.key===n.key);if(!o||!m){o&&!m?l.debug(`Component ${n.component_id} found but key mismatch (queued: ${n.key}, found: ${o.key}), attempting replay with snapshot state: ${s}`):l.debug(`Component ${n.component_id} not found, attempting replay with snapshot state: ${s}`),await this.replayCallWithoutComponent(r)?l.debug(`Successfully replayed ${s} without component instance`):l.debug(`Failed to replay ${s} - skipping`);continue}l.debug(`Replaying queued call: ${s} (component_id: ${n.component_id}, key: ${n.key})`);let u=Math.random().toString(36).substring(2,15),p=o.$el,_=l.getStateWithChildren(o);if(_.args=i||[],!o.__serverMethods||o.__serverMethods.length===0){console.error("No server methods available for queued call");continue}let w=o.__serverMethods[0].endpoint,y=c||o.__componentMetadata,g={protocol:"tetra-1.0",id:u,type:"call",payload:{component_id:o.$el.getAttribute("tetra-component-id"),method:s,args:_.args,state:_.data,encrypted_state:_.encrypted,children_state:_.children,app_name:y.app_name,library_name:y.library_name,component_name:y.component_name}},b={method:"POST",headers:{"T-Request":"true","T-Current-URL":document.location.href,"X-CSRFToken":window.__tetra_csrfToken,"Content-Type":"application/json"},mode:"same-origin",body:l.jsonEncode(g)};o.$dispatch("tetra:before-request",{component:o,triggerEl:p,requestId:u});try{let f=await fetch(w,b);if(o.$dispatch("tetra:after-request",{component:o,triggerEl:p,requestId:u}),f.status===401||f.status===403){console.error(`Auth error (${f.status}) replaying queued call to ${s}, rolling back`),this.rollbackOptimisticUpdate(o,a),o.$dispatch("tetra:call-rolled-back",{component:o,methodName:s,status:f.status,reason:"auth_error"});continue}if(f.status===409){console.warn(`Conflict (409) replaying queued call to ${s}, refreshing component`),await o._updateHtml().catch(k=>{console.error("Error refreshing component after conflict:",k)}),o.$dispatch("tetra:call-conflict",{component:o,methodName:s});continue}if(f.status>=500){console.warn(`Server error (${f.status}) replaying queued call to ${s}, will retry`),this.rollbackOptimisticUpdate(o,a),this.offlineCallQueue.push(r);continue}if(!f.ok){console.error(`HTTP error ${f.status} replaying queued call to ${s}`),this.rollbackOptimisticUpdate(o,a),o.$dispatch("tetra:call-failed",{component:o,methodName:s,status:f.status});continue}let S=await this.handleServerMethodResponse(f,o);l.debug(`Queued call ${s} completed successfully`),o.$dispatch("tetra:call-reconciled",{component:o,methodName:s,result:S})}catch(f){if(f instanceof TypeError&&(f.message.includes("fetch")||f.message.includes("NetworkError"))){console.warn("Network error during queue replay, rolling back and re-queuing:",f),this.rollbackOptimisticUpdate(o,a),o.$dispatch("tetra:after-request",{component:o,triggerEl:p,requestId:u}),this.offlineCallQueue.unshift(r),this.setOfflineStatus();break}console.error("Error replaying queued call:",f),o.$dispatch("tetra:after-request",{component:o,triggerEl:p,requestId:u})}}catch(n){console.error("Error processing queued call:",n)}this.offlineCallQueue.length>0&&this.scheduleQueueRetry(),document.dispatchEvent(new CustomEvent("tetra:queue-processing-complete",{detail:{processedCount:e,remainingCount:this.offlineCallQueue.length}}))},async replayCallWithoutComponent(e){var m;let{component:t,methodName:r,args:n,componentMetadata:s,preCallSnapshot:i}=e;if(!i||!i.data.__state)return console.warn(`Cannot replay ${r} - no snapshot state available`),!1;let c=Math.random().toString(36).substring(2,15),a=s,d={protocol:"tetra-1.0",id:c,type:"call",payload:{component_id:t.component_id,method:r,args:n||[],state:i.data,encrypted_state:i.data.__state,children_state:[],app_name:a.app_name,library_name:a.library_name,component_name:a.component_name}},h="/tetra/call/",o={method:"POST",headers:{"T-Request":"true","T-Current-URL":document.location.href,"X-CSRFToken":window.__tetra_csrfToken,"Content-Type":"application/json"},mode:"same-origin",body:l.jsonEncode(d)};try{let u=await fetch(h,o);if(u.status===401||u.status===403)return console.error(`Auth error (${u.status}) replaying ${r} without component - skipping`),!1;if(u.status===409)return console.warn(`Conflict (409) replaying ${r} without component - state was stale`),!0;if(u.status>=500)return console.warn(`Server error (${u.status}) replaying ${r} without component - will retry`),this.offlineCallQueue.push(e),!1;if(!u.ok)return console.error(`HTTP error ${u.status} replaying ${r} without component`),!1;let p=await u.json();return(m=p.metadata)!=null&&m.messages&&p.metadata.messages.forEach(_=>{document.dispatchEvent(new CustomEvent("tetra:new-message",{detail:_}))}),document.dispatchEvent(new CustomEvent("tetra:call-replayed-without-component",{detail:{componentId:t.component_id,methodName:r,response:p}})),!0}catch(u){return u instanceof TypeError&&(u.message.includes("fetch")||u.message.includes("NetworkError"))?(console.warn("Network error during replay without component, re-queuing:",u),this.offlineCallQueue.unshift(e),this.setOfflineStatus(),!1):(console.error("Error replaying call without component:",u),!1)}},rollbackOptimisticUpdate(e,t){if(t){for(let r in t.data)e.hasOwnProperty(r)&&(e[r]=t.data[r]);if(t.html&&e.$el)try{Alpine.morph(e.$root,t.html,{lookahead:!0}),l.debug("Rolled back component HTML to pre-call state")}catch(r){console.error("Error during rollback morph:",r)}e.$dispatch("tetra:state-rolled-back",{component:e})}},captureComponentSnapshot(e){let t={data:{},html:e.$el?e.$el.outerHTML:null,timestamp:Date.now()};for(let r in e)if(!r.startsWith("_")&&!r.startsWith("$")&&!r.startsWith("__")&&typeof e[r]!="function")try{t.data[r]=JSON.parse(JSON.stringify(e[r]))}catch{t.data[r]=e[r]}return e.__state&&(t.data.__state=e.__state),e.component_id&&(t.component_id=e.component_id),e.key&&(t.key=e.key),l.debug(`Captured snapshot for component ${e.component_id} (key: ${e.key})`),t},queueOfflineCall(e,t,r,n,s,i){l.debug(`Queuing call to ${t} - connection offline`),this.offlineCallQueue.push({component:{component_id:e.component_id,key:e.key},methodName:t,args:r,componentMetadata:n,preCallSnapshot:s,optimisticUpdate:i,queuedAt:Date.now()}),e.$dispatch("tetra:call-queued",{component:e,methodName:t,queueLength:this.offlineCallQueue.length}),l.debug(`Call queued: ${t}, component id: ${e.component_id} (queue length: ${this.offlineCallQueue.length})`)},sendWebSocketMessage(e){if(!this.ws){console.log("WebSocket is not connected. Cannot send message.");return}this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):(e.type==="subscribe"&&e.component_id&&this.pendingSubscriptions.set(e.component_id,e),this.ws.addEventListener("open",()=>{this.ws.send(JSON.stringify(e))},{once:!0}))},alpineComponentMixins(){return{init(){if(this.component_id=this.$el.getAttribute("tetra-component-id"),this.$dispatch("tetra:child-component-init",{component:this}),this.__initServerWatchers(),this.__initStores(),window.__tetra_useWebsockets&&this.$el.hasAttribute("tetra-reactive")){l.ensureWebSocketConnection();let n=this.$el.getAttribute("tetra-subscription");n&&this._subscribe(n)}this.__initInner&&this.__initInner(),this._handleAutofocus();let e=()=>{[this.$el,...Array.from(this.$el.querySelectorAll("[t-indicator]"))].forEach(s=>{let i=s.getAttribute("t-indicator");i&&document.querySelectorAll(i).forEach(c=>{c.getAttribute("hidden")===null&&(c.hidden=!0),c.classList.add("tetra-indicator-"+this.component_id)})})};e(),this.$el.addEventListener("tetra:component-updated",e);let t=(n,s)=>{let i=n.detail.triggerEl||n.target,c=n.detail.requestId;if(!this.$el.contains(i)&&this.$el!==i)return;if(this.__activeRequests||(this.__activeRequests=new Map),s){let o="";i.id&&(o="#"+i.id),this.__activeRequests.set(c,{triggerSelector:o,indicatorSelector:i.getAttribute("t-indicator"),completed:!1})}else{let o=this.__activeRequests.get(c);o&&(o.completed=!0),setTimeout(()=>{this.__activeRequests.delete(c)},500)}let a=(o,m,u)=>(o.__activeRequests||(o.__activeRequests=new Set),u?o.__activeRequests.add(m):o.__activeRequests.delete(m),o.__activeRequests.size>0),d=a(i,c,s);i.classList.toggle("tetra-request",d);let h=i.getAttribute("t-indicator");if(h){let o=Array.from(this.$el.querySelectorAll(h)),m=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),u=new Set(o);m.forEach(p=>{p.matches(h)&&u.add(p)}),u.forEach(p=>{a(p,c,s)?(p.removeAttribute("hidden"),p.hidden=!1):(p.setAttribute("hidden",""),p.hidden=!0)})}},r=()=>{!this.__activeRequests||this.__activeRequests.size===0||this.__activeRequests.forEach((n,s)=>{if(!n.completed&&(n.triggerSelector&&this.$el.querySelectorAll(n.triggerSelector).forEach(c=>{c.__activeRequests||(c.__activeRequests=new Set),c.__activeRequests.add(s),c.classList.add("tetra-request")}),n.indicatorSelector)){let i=Array.from(this.$el.querySelectorAll(n.indicatorSelector)),c=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),a=new Set(i);c.forEach(d=>{d.matches(n.indicatorSelector)&&a.add(d)}),a.forEach(d=>{d.__activeRequests||(d.__activeRequests=new Set),d.__activeRequests.add(s),d.removeAttribute("hidden"),d.hidden=!1})}})};this.$el.addEventListener("tetra:before-request",n=>t(n,!0)),this.$el.addEventListener("tetra:after-request",n=>t(n,!1)),this.$el.addEventListener("tetra:component-updated",r)},destroy(){var r;this.$dispatch("tetra:child-component-destroy",{component:this});let e=!1,t=this.$el.parentElement;for(;t;){let n=(r=t._x_dataStack)==null?void 0:r[0];if(n&&n.__isUpdating){e=!0;break}t=t.parentElement}!this.__isUpdating&&!e&&this.__subscribedGroups&&[...this.__subscribedGroups].forEach(n=>{this._unsubscribe(n)}),this.__destroyInner&&this.__destroyInner()},async _updateHtml(e){if(e||(e=await this._fetchHtml()),!!e){this.__isUpdating=!0;try{Alpine.morph(this.$root,e,{updating(t,r,n,s){if(r.hasAttribute&&r.hasAttribute("x-data-maintain")&&t.hasAttribute&&t.hasAttribute("x-data"))r.setAttribute("x-data",t.getAttribute("x-data")),r.removeAttribute("x-data-maintain");else if(r.hasAttribute&&r.hasAttribute("x-data-update")&&t.hasAttribute&&t.hasAttribute("x-data")){let i=l.jsonDecode(r.getAttribute("x-data-update")),c=l.jsonDecode(r.getAttribute("x-data-update-old")),a=window.Alpine.$data(t);for(let d in i)c.hasOwnProperty(d)&&c[d]!==a[d]||(a[d]=i[d]);r.setAttribute("x-data",t.getAttribute("x-data")),r.removeAttribute("x-data-update")}},lookahead:!0})}catch(t){console.error("Error during Alpine.morph:",t),console.error("HTML that caused the error:",e)}finally{this.__isUpdating=!1}this._handleAutofocus(),this.$dispatch("tetra:component-updated",{component:this})}},_updateData(e){let t=document.activeElement,r=null;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.tagName==="SELECT")&&this.$el.contains(t)&&(r=t.getAttribute("x-model"),!r)){let n=t.parentElement;for(;n&&n!==this.$el&&!r;)r=n.getAttribute("x-model"),n=n.parentElement}for(let n in e){if(r===n){l.debug(`Skipping update for focused field: ${n}`);continue}this[n]=e[n]}this.$dispatch("tetra:component-data-updated",{component:this})},_setValueByName(e,t){let r=document.getElementsByName(e);for(let n=0;n<r.length;n++)r[n].value=t},_removeComponent(){this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.remove(),l.debug(`Removed component with key ${this.key} and ID ${this.component_id}`)},_replaceComponent(e){this.__isUpdating=!0,this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.insertAdjacentHTML("afterend",e),this.$root.remove(),this.__isUpdating=!1,this.$dispatch("tetra:component-updated",{component:this}),this._handleAutofocus(),l.debug(`Replaced component with key ${this.key} and ID ${this.component_id}`)},_redirect(e){document.location=e},_dispatch(e,t){this.$dispatch(e,{_component:this,...t})},_pushUrl(e,t=!1){t?window.history.replaceState(null,"",e):window.history.pushState(null,"",e)},_updateSearchParam(e,t){let r=new URL(window.location);t?r.searchParams.set(e,t):r.searchParams.delete(e),window.history.pushState(null,"",r.toString())},_handleAutofocus(){this.$nextTick(()=>{if(!this.$root)return;let e=this.$root.querySelector("[autofocus]");e&&e.focus()})},async _fetchHtml(){var r;if(!((r=this.__serverMethods)==null?void 0:r.find(n=>n.name==="_refresh")))throw new Error("_refresh method not found in component server methods");let t=await l.callServerMethod(this,"_refresh",[],this.__componentMetadata);return(t==null?void 0:t.html)||t},_subscribe(e){this.__subscribedGroups||(this.__subscribedGroups=new Set);let t=Alpine.store("tetra_subscriptions");if(this.__subscribedGroups.add(e),t[e]||(t[e]=[]),!t[e].includes(this.component_id)){let r=t[e].length===0;t[e].push(this.component_id),r&&l.sendWebSocketMessage({type:"subscribe",group:e,component_id:this.component_id,component_class:this.componentName})}},_unsubscribe(e){var r;if(!this.__subscribedGroups)return;let t=Alpine.store("tetra_subscriptions");if(this.__subscribedGroups.delete(e),t[e]){let n=t[e].indexOf(this.component_id);if(n>-1){t[e].splice(n,1);let s=t[e].length===0,i=!1;if(this.$el){let c=this.$el.parentElement;for(;c;){let a=(r=c._x_dataStack)==null?void 0:r[0];if(a&&a.__isUpdating){i=!0;break}c=c.parentElement}}s&&!i?(delete t[e],l.sendWebSocketMessage({type:"unsubscribe",group:e,component_id:this.component_id})):s&&i?window.__tetra_debug&&l.debug(`Skipping unsubscribe from ${e} - parent is morphing, component likely being recreated`):window.__tetra_debug&&l.debug(`Component ${this.component_id} unsubscribed from ${e}, but ${t[e].length} components still subscribed`)}}},_notifyGroup(e,t,r){return l.sendWebSocketMessage({type:"notify",group:e,event_name:t,data:r,sender_id:this.component_id})},__initServerWatchers(){this.__serverMethods.forEach(e=>{e.watch&&e.watch.forEach(t=>{this.$watch(t,async(r,n)=>{await this[e.name](r,n,t)})})})},__initStores(){this.__serverStores&&Object.entries(this.__serverStores).forEach(([e,t])=>{let r=t.split("."),n=r[0],s=r.slice(1);Alpine.store(n)||Alpine.store(n,{});let i=()=>{let h=Alpine.store(n);for(let o of s){if(h==null||typeof h!="object")return;h=h[o]}return h},c=h=>{if(s.length===0)Alpine.store(n)!==h&&Alpine.store(n,h);else{let o=Alpine.store(n);for(let u=0;u<s.length-1;u++){let p=s[u];(!(p in o)||typeof o[p]!="object")&&(o[p]={}),o=o[p]}let m=s[s.length-1];o[m]!==h&&(o[m]=h)}},a=i();Alpine.effect(()=>{let h=i();h!==a&&h!==void 0&&(a=h,this[e]!==h&&(this.__isSyncingFromStore=e,this[e]=h,this.$nextTick(()=>{this.__isSyncingFromStore===e&&(this.__isSyncingFromStore=null)})))}),this.$watch(e,h=>{this.__isSyncingFromStore!==e&&i()!==h&&(c(h),a=h)});let d=i();d!==void 0?(this[e]=d,a=d):(c(this[e]),a=this[e])})},__childComponents:{},__rootBind:{"@tetra:child-component-init"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(t.key&&(this.__childComponents[t.key]=t),t._parent=this)},"@tetra:child-component-destroy"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(delete this.__childComponents[t.key],e.detail.component._parent=null)}}}},makeServerMethods(e,t){let r={};return e.forEach(n=>{var s=async function(...i){return await l.callServerMethod(this,n.name,i,t)};n.debounce?s=l.debounce(s,n.debounce,n.debounce_immediate):n.throttle&&(s=l.throttle(s,n.throttle,{leading:n.throttle_leading,trailing:n.throttle_trailing})),r[n.name]=s}),r},makeAlpineComponent(e,t,r,n,s){Alpine.data(e,i=>{let{init:c,destroy:a,...d}=t,h=l.jsonDecode(i);return{componentName:e,__initInner:c,__destroyInner:a,__serverMethods:r,__serverProperties:n,__componentMetadata:s,__serverStores:h==null?void 0:h.__serverStores,...h||{},...d,...l.makeServerMethods(r,s),...l.alpineComponentMixins()}})},getStateWithChildren(e){let t={};e.__serverProperties.forEach(n=>{t[n]=e[n]}),e.__serverStores&&(t.__serverStores=e.__serverStores);let r={encrypted:e.__state,data:t,children:[]};for(let n in e.__childComponents){let s=e.__childComponents[n];r.children.push(l.getStateWithChildren(s))}return r},loadScript(e){return new Promise((t,r)=>{let n=document.createElement("script");n.src=e,n.onload=t,n.onerror=r,document.head.appendChild(n)})},loadStyles(e){return new Promise((t,r)=>{let n=document.createElement("link");n.href=e,n.rel="stylesheet",n.type="text/css",n.onload=t,n.onerror=r,document.head.appendChild(n)})},getFilenameFromContentDisposition(e){if(!e)return null;let t=/filename\*=([^']*)'([^']*)'([^;]*)/i.exec(e);if(t)try{return decodeURIComponent(t[3])}catch(r){console.warn("Error decoding filename:",r)}return t=/filename=["']?([^"';\n]*)["']?/i.exec(e),t?t[1]:null},async handleServerMethodResponse(e,t){if(e.status===410){let r=await e.text(),n=l.jsonDecode(r);if(n.error&&n.error.code==="StaleComponentState")return console.warn(`Component has stale state: ${n.error.message}`),t&&t._removeComponent&&t._removeComponent(),document.dispatchEvent(new CustomEvent("tetra:component-stale",{detail:{component:t,error:n.error}})),null}if(e.status===200){let r=e.headers.get("Content-Disposition");if(r!=null&&r.startsWith("attachment")){let u=document.createElement("a");u.href=URL.createObjectURL(await e.blob()),u.download=this.getFilenameFromContentDisposition(r),u.click(),u.remove();return}let n=await e.text(),s=l.jsonDecode(n),i=!1,c=null,a=null,d=[],h=[],o=[],m=[];if(s.protocol!=="tetra-1.0")throw new Error("Invalid or missing Tetra protocol in server response");if(i=s.success,s.payload&&(c=s.payload.result,a=s.payload.html),s.metadata){d=s.metadata.js||[],h=s.metadata.styles||[],o=s.metadata.messages||[],m=s.metadata.callbacks||[];let u=m.find(p=>p.callback&&p.callback.length===1&&p.callback[0]==="_redirect");if(u&&u.args&&u.args.length>0){document.location=u.args[0];return}}if(!i&&s.error&&(console.error(`Tetra method error [${s.error.code}]: ${s.error.message}`),document.dispatchEvent(new CustomEvent("tetra:method-error",{detail:{component:t,error:s.error}}))),o&&o.forEach(u=>{t.$dispatch("tetra:new-message",u)}),i){let u=[];if(d.forEach(p=>{document.querySelector(`script[src="${CSS.escape(p)}"]`)||u.push(l.loadScript(p))}),h.forEach(p=>{document.querySelector(`link[href="${CSS.escape(p)}"]`)||u.push(l.loadStyles(p))}),await Promise.all(u),a&&t._updateHtml(a),m){let p=new Set(["_redirect","_updateHtml","_updateData","_dispatch","_pushUrl","_updateSearchParam","_replaceComponent","_removeComponent","_setValueByName"]);m.forEach(_=>{if(!_.callback||!Array.isArray(_.callback)||_.callback.length===0){console.error("Invalid callback structure: missing or invalid callback array");return}let w=_.callback[0];if(!p.has(w)){console.error(`Blocked disallowed callback method: ${w}`);return}if(_.callback.some(g=>g==="__proto__"||g==="constructor"||g==="prototype")){console.error("Blocked callback with dangerous property access");return}let y=t;try{_.callback.forEach((g,b)=>{b===_.callback.length-1?typeof y[g]=="function"?y[g](..._.args):console.error(`Callback target is not a function: ${g}`):y=y[g]})}catch(g){console.error("Error executing callback:",g)}})}return c}else throw s.error?new Error(`Error processing public method: ${s.error.message}`):new Error("Error processing public method")}else throw new Error(`Server responded with an error ${e.status} (${e.statusText})`)},async callServerMethod(e,t,r,n){var g;let s=Math.random().toString(36).substring(2,15),i=e.$event?e.$event.target:e.$el;l.debug(`callServerMethod: ${t} on component ${e.component_id} (key: ${e.key})`);let c=this.captureComponentSnapshot(e);if(!e.__serverMethods||e.__serverMethods.length===0)return console.error("No server methods available. Component may not be properly initialized."),Promise.reject(new Error("No server methods available"));let a=e.__serverMethods[0].endpoint,d=n||e.__componentMetadata;if(!d)debugger;let h=!navigator.onLine,m=window.__tetra_useWebsockets&&((g=e.$el)==null?void 0:g.hasAttribute("tetra-reactive"))&&(!this.ws||this.ws.readyState!==WebSocket.OPEN);if(h||m)return this.queueOfflineCall(e,t,r,d,c,null),null;let u=l.getStateWithChildren(e);u.args=r||[];let p={protocol:"tetra-1.0",id:s,type:"call",payload:{component_id:e.$el.getAttribute("tetra-component-id"),method:t,args:u.args,state:u.data,encrypted_state:u.encrypted,children_state:u.children,app_name:d.app_name,library_name:d.library_name,component_name:d.component_name}},_={method:"POST",headers:{"T-Request":"true","T-Current-URL":document.location.href,"X-CSRFToken":window.__tetra_csrfToken},mode:"same-origin"},w=new FormData,y=!1;for(let[b,f]of Object.entries(u.data))f instanceof File&&(y=!0,p.payload.state[b]={},w.append(b,f));y?(w.append("tetra_payload",l.jsonEncode(p)),_.body=w):(_.body=l.jsonEncode(p),_.headers["Content-Type"]="application/json"),e.$dispatch("tetra:before-request",{component:e,triggerEl:i,requestId:s}),this.updateOnlineStatus();try{let b=await fetch(a,_);e.$dispatch("tetra:after-request",{component:e,triggerEl:i,requestId:s});let f=await this.handleServerMethodResponse(b,e);return this.offlineCallQueue.length>0&&this.scheduleQueueRetry(),f}catch(b){if(b instanceof TypeError||b.message.toLowerCase().includes("network")||b.message.toLowerCase().includes("fetch"))return console.warn(`Network error calling ${t}, queueing for retry:`,b.message),e.$dispatch("tetra:after-request",{component:e,triggerEl:i,requestId:s}),this.queueOfflineCall(e,t,r,d,c,null),this.setOfflineStatus(),null;throw e.$dispatch("tetra:after-request",{component:e,triggerEl:i,requestId:s}),b}},jsonReplacer(e,t){return t instanceof Date?{__type:"datetime",value:t.toISOString()}:t instanceof Set?{__type:"set",value:Array.from(t)}:t},jsonReviver(e,t){if(t&&typeof t=="object"&&t.__type){if(t.__type==="datetime")return new Date(t);if(t.__type==="set")return new Set(t)}return t},jsonEncode(e){return JSON.stringify(e,l.jsonReplacer)},jsonDecode(e){return JSON.parse(e,l.jsonReviver)},debounce(e,t,r){var n;return function(){var s=this,i=arguments,c=function(){n=null,r||e.apply(s,i)},a=r&&!n;clearTimeout(n),n=setTimeout(c,t),a&&e.apply(s,i)}},throttle(e,t,r){var n,s,i,c,a=0;r||(r={});var d=function(){a=r.leading===!1?0:Date.now(),n=null,c=e.apply(s,i),n||(s=i=null)},h=function(){var o=Date.now();!a&&r.leading===!1&&(a=o);var m=t-(o-a);return s=this,i=arguments,m<=0||m>t?(n&&(clearTimeout(n),n=null),a=o,c=e.apply(s,i),n||(s=i=null)):!n&&r.trailing!==!1&&(n=setTimeout(d,m)),c};return h.cancel=function(){clearTimeout(n),a=0,n=s=i=null},h}},v=l;window.Tetra=v;window.document.addEventListener("alpine:init",()=>{v.init()});})();
//# sourceMappingURL=tetra.min.js.map
