(()=>{var p={ws:null,pendingSubscriptions:new Map,init(){Alpine.magic("static",()=>p.$static),window.__tetra_useWebsockets&&this.ensureWebSocketConnection(),window.__tetra_messages&&(this.handleInitialMessages(window.__tetra_messages),delete window.__tetra_messages),Alpine.store("tetra_subscriptions")||Alpine.store("tetra_subscriptions",{})},handleInitialMessages(e){e.forEach(s=>{document.dispatchEvent(new CustomEvent("tetra:new-message",{detail:s,bubbles:!0}))})},$static(){return e=>window.__tetra_staticRoot+e},ensureWebSocketConnection(){if(!this.ws||this.ws.readyState===WebSocket.CLOSED){console.log("Connecting to Tetra WebSocket...");let s=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws/tetra/`;this.ws=new WebSocket(s),this.ws.onopen=()=>{console.debug("Tetra WebSocket connected"),this.pendingSubscriptions.forEach((r,t)=>{this.ws.send(JSON.stringify(r))}),this.pendingSubscriptions.clear()},this.ws.onmessage=r=>{let t=JSON.parse(r.data);this.handleWebsocketMessage(t)},this.ws.onclose=()=>{console.log("Tetra WebSocket disconnected"),setTimeout(()=>{this.ensureWebSocketConnection()},3e3)},this.ws.onerror=r=>{console.error("Tetra WebSocket error:",r)}}return this.ws},_get_component_by_id(e){let s=document.querySelector(`[tetra-component-id="${e}"]`);if(!s){console.error(`AlpineJs Component with ID ${e} not found.`);return}return Alpine.$data(s)},_get_components_by_subscribe_group(e){let t=(Alpine.store("tetra_subscriptions")[e]||[]).map(o=>this._get_component_by_id(o)).filter(o=>!!o&&typeof o._removeComponent=="function");return[...new Set(t)]},handleWebsocketMessage(e){let s,r,t={};if(e.protocol!=="tetra-1.0"){console.warn("Invalid or missing Tetra protocol in WebSocket message:",e);return}switch(s=e.type,r=e.payload,t=e.metadata||{},s){case"subscription.response":this.handleSubscriptionResponse(r);break;case"notify":this.handleGroupNotify(r);break;case"component.data_updated":this.handleComponentUpdateData(r);break;case"component.removed":this.handleComponentRemove(r);break;case"component.created":this.handleComponentCreated(r);break;default:console.warn("Unknown WebSocket message type:",s,":",e)}},handleSubscriptionResponse(e){switch(e.status){case"subscribed":console.debug("Subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-subscribed",{detail:{component:this,group:e.group}}));break;case"unsubscribed":console.debug("Subscription to group",e.group,"redacted successfully."),document.dispatchEvent(new CustomEvent("tetra:component-unsubscribed",{detail:{component:this,group:e.group}}));break;case"resubscribed":console.debug("Re-subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-resubscribed",{detail:{component:this,group:e.group}}));break;case"error":console.error("Error subscribing component",e.component_id,"to group",e.group,":",e.message),document.dispatchEvent(new CustomEvent("tetra:component-subscription-error",{detail:{component:this,group:e.group,message:e.message}}));break;default:console.debug("Subscription response faulty:",e)}},handleGroupNotify(e){let{group:s,event_name:r,data:t}=e;document.dispatchEvent(new CustomEvent(r,{detail:{data:t,group:s}}))},handleComponentUpdateData(e){let{group:s,data:r,sender_id:t}=e;this._get_components_by_subscribe_group(s).forEach(i=>{t&&i.__activeRequests&&i.__activeRequests.has(t)||(r&&Object.keys(r).length>0?i._updateData(r):i._refresh())})},handleComponentRemove(e){let{type:s,group:r,component_id:t,target_group:o,sender_id:i}=e;if(t){let n=this._get_component_by_id(t);if(n&&n._removeComponent){if(i&&n.__activeRequests&&n.__activeRequests.has(i))return;n._removeComponent()}return}if(o){this._get_components_by_subscribe_group(o).forEach(a=>{if(a&&a._removeComponent){if(i&&a.__activeRequests&&a.__activeRequests.has(i))return;a._removeComponent()}});return}this._get_components_by_subscribe_group(r).forEach(n=>{if(n&&n._removeComponent){if(i&&n.__activeRequests&&n.__activeRequests.has(i))return;n._removeComponent()}})},handleComponentCreated(e){let{group:s,data:r,component_id:t,target_group:o,sender_id:i}=e;this._get_components_by_subscribe_group(s).forEach(n=>{i&&n.__activeRequests&&n.__activeRequests.has(i)||(typeof n._refresh=="function"?n._refresh():n._updateHtml())})},sendWebSocketMessage(e){if(!this.ws){console.log("WebSocket is not connected. Cannot send message.");return}this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):(e.type==="subscribe"&&e.component_id&&this.pendingSubscriptions.set(e.component_id,e),this.ws.addEventListener("open",()=>{this.ws.send(JSON.stringify(e))},{once:!0}))},alpineComponentMixins(){return{init(){if(this.component_id=this.$el.getAttribute("tetra-component-id"),this.$dispatch("tetra:child-component-init",{component:this}),this.__initServerWatchers(),this.__initStores(),window.__tetra_useWebsockets&&this.$el.hasAttribute("tetra-reactive")){p.ensureWebSocketConnection();let t=this.$el.getAttribute("tetra-subscription");t&&this._subscribe(t)}this.__initInner&&this.__initInner(),this._handleAutofocus();let e=()=>{[this.$el,...Array.from(this.$el.querySelectorAll("[t-indicator]"))].forEach(o=>{let i=o.getAttribute("t-indicator");i&&document.querySelectorAll(i).forEach(c=>{c.getAttribute("hidden")===null&&(c.hidden=!0),c.classList.add("tetra-indicator-"+this.component_id)})})};e(),this.$el.addEventListener("tetra:component-updated",e);let s=(t,o)=>{let i=t.detail.triggerEl||t.target,c=t.detail.requestId;if(!this.$el.contains(i)&&this.$el!==i)return;if(this.__activeRequests||(this.__activeRequests=new Map),o){let l="";i.id&&(l="#"+i.id),this.__activeRequests.set(c,{triggerSelector:l,indicatorSelector:i.getAttribute("t-indicator"),completed:!1})}else{let l=this.__activeRequests.get(c);l&&(l.completed=!0),setTimeout(()=>{this.__activeRequests.delete(c)},5e3)}let n=(l,_,h)=>(l.__activeRequests||(l.__activeRequests=new Set),h?l.__activeRequests.add(_):l.__activeRequests.delete(_),l.__activeRequests.size>0),a=n(i,c,o);i.classList.toggle("tetra-request",a);let d=i.getAttribute("t-indicator");if(d){let l=Array.from(this.$el.querySelectorAll(d)),_=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),h=new Set(l);_.forEach(u=>{u.matches(d)&&h.add(u)}),h.forEach(u=>{n(u,c,o)?(u.removeAttribute("hidden"),u.hidden=!1):(u.setAttribute("hidden",""),u.hidden=!0)})}},r=()=>{!this.__activeRequests||this.__activeRequests.size===0||this.__activeRequests.forEach((t,o)=>{if(!t.completed&&(t.triggerSelector&&this.$el.querySelectorAll(t.triggerSelector).forEach(c=>{c.__activeRequests||(c.__activeRequests=new Set),c.__activeRequests.add(o),c.classList.add("tetra-request")}),t.indicatorSelector)){let i=Array.from(this.$el.querySelectorAll(t.indicatorSelector)),c=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),n=new Set(i);c.forEach(a=>{a.matches(t.indicatorSelector)&&n.add(a)}),n.forEach(a=>{a.__activeRequests||(a.__activeRequests=new Set),a.__activeRequests.add(o),a.removeAttribute("hidden"),a.hidden=!1})}})};this.$el.addEventListener("tetra:before-request",t=>s(t,!0)),this.$el.addEventListener("tetra:after-request",t=>s(t,!1)),this.$el.addEventListener("tetra:component-updated",r)},destroy(){this.$dispatch("tetra:child-component-destroy",{component:this}),!this.__isUpdating&&this.__subscribedGroups&&[...this.__subscribedGroups].forEach(e=>{this._unsubscribe(e)}),this.__destroyInner&&this.__destroyInner()},_updateHtml(e){if(this.__isUpdating=!0,Alpine.morph(this.$root,e,{updating(s,r,t,o){if(r.hasAttribute&&r.hasAttribute("x-data-maintain")&&s.hasAttribute&&s.hasAttribute("x-data"))r.setAttribute("x-data",s.getAttribute("x-data")),r.removeAttribute("x-data-maintain");else if(r.hasAttribute&&r.hasAttribute("x-data-update")&&s.hasAttribute&&s.hasAttribute("x-data")){let i=p.jsonDecode(r.getAttribute("x-data-update")),c=p.jsonDecode(r.getAttribute("x-data-update-old")),n=window.Alpine.$data(s);for(let a in i)c.hasOwnProperty(a)&&c[a]!==n[a]||(n[a]=i[a]);r.setAttribute("x-data",s.getAttribute("x-data")),r.removeAttribute("x-data-update")}},lookahead:!0}),this.__isUpdating=!1,window.__tetra_useWebsockets&&this.$el.hasAttribute("tetra-reactive")){let s=this.$el.getAttribute("tetra-subscription"),r=s?s.split(",").map(o=>o.trim()):[];(this.__subscribedGroups?Array.from(this.__subscribedGroups):[]).forEach(o=>{r.includes(o)||this._unsubscribe(o)}),r.forEach(o=>{(!this.__subscribedGroups||!this.__subscribedGroups.has(o))&&this._subscribe(o)})}this._handleAutofocus(),this.$dispatch("tetra:component-updated",{component:this})},_updateData(e){let s=document.activeElement,r=null;if(s&&(s.tagName==="INPUT"||s.tagName==="TEXTAREA"||s.tagName==="SELECT")&&this.$el.contains(s)&&(r=s.getAttribute("x-model"),!r)){let t=s.parentElement;for(;t&&t!==this.$el&&!r;)r=t.getAttribute("x-model"),t=t.parentElement}for(let t in e){if(r===t){console.debug(`Skipping update for focused field: ${t}`);continue}this[t]=e[t]}this.$dispatch("tetra:component-data-updated",{component:this})},_setValueByName(e,s){let r=document.getElementsByName(e);for(let t=0;t<r.length;t++)r[t].value=s},_removeComponent(){this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.remove()},_replaceComponent(e){this.__isUpdating=!0,this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.insertAdjacentHTML("afterend",e),this.$root.remove(),this.__isUpdating=!1,this.$dispatch("tetra:component-updated",{component:this}),this._handleAutofocus()},_redirect(e){document.location=e},_dispatch(e,s){this.$dispatch(e,{_component:this,...s})},_pushUrl(e,s=!1){s?window.history.replaceState(null,"",e):window.history.pushState(null,"",e)},_updateSearchParam(e,s){let r=new URL(window.location);s?r.searchParams.set(e,s):r.searchParams.delete(e),window.history.pushState(null,"",r.toString())},_handleAutofocus(){this.$nextTick(()=>{if(!this.$root)return;let e=this.$root.querySelector("[autofocus]");e&&e.focus()})},_subscribe(e){this.__subscribedGroups||(this.__subscribedGroups=new Set);let s=Alpine.store("tetra_subscriptions");e.split(",").map(t=>t.trim()).forEach(t=>{if(this.__subscribedGroups.add(t),s[t]||(s[t]=[]),!s[t].includes(this.component_id)){let o=s[t].length===0;s[t].push(this.component_id),o&&p.sendWebSocketMessage({type:"subscribe",group:t,component_id:this.component_id,component_class:this.componentName})}})},_unsubscribe(e){if(!this.__subscribedGroups)return;let s=Alpine.store("tetra_subscriptions");e.split(",").map(t=>t.trim()).forEach(t=>{if(this.__subscribedGroups.delete(t),s[t]){let o=s[t].indexOf(this.component_id);o>-1&&(s[t].splice(o,1),s[t].length===0&&(delete s[t],p.sendWebSocketMessage({type:"unsubscribe",group:t,component_id:this.component_id})))}})},_notifyGroup(e,s,r){return p.sendWebSocketMessage({type:"notify",group:e,event_name:s,data:r,sender_id:this.component_id})},__initServerWatchers(){this.__serverMethods.forEach(e=>{e.watch&&e.watch.forEach(s=>{this.$watch(s,async(r,t)=>{await this[e.name](r,t,s)})})})},__initStores(){this.__serverStores&&Object.entries(this.__serverStores).forEach(([e,s])=>{let r=s.split("."),t=r[0],o=r.slice(1);Alpine.store(t)||Alpine.store(t,{});let i=()=>{let d=Alpine.store(t);for(let l of o){if(d==null||typeof d!="object")return;d=d[l]}return d},c=d=>{if(o.length===0)Alpine.store(t)!==d&&Alpine.store(t,d);else{let l=Alpine.store(t);for(let h=0;h<o.length-1;h++){let u=o[h];(!(u in l)||typeof l[u]!="object")&&(l[u]={}),l=l[u]}let _=o[o.length-1];l[_]!==d&&(l[_]=d)}},n=i();Alpine.effect(()=>{let d=i();d!==n&&d!==void 0&&(n=d,this[e]!==d&&(this.__isSyncingFromStore=e,this[e]=d,this.$nextTick(()=>{this.__isSyncingFromStore===e&&(this.__isSyncingFromStore=null)})))}),this.$watch(e,d=>{this.__isSyncingFromStore!==e&&i()!==d&&(c(d),n=d)});let a=i();a!==void 0?(this[e]=a,n=a):(c(this[e]),n=this[e])})},__childComponents:{},__rootBind:{"@tetra:child-component-init"(e){e.stopPropagation();let s=e.detail.component;s.key!==this.key&&(s.key&&(this.__childComponents[s.key]=s),s._parent=this)},"@tetra:child-component-destroy"(e){e.stopPropagation();let s=e.detail.component;s.key!==this.key&&(delete this.__childComponents[s.key],e.detail.component._parent=null)}}}},makeServerMethods(e){let s={};return e.forEach(r=>{var t=async function(...o){return await p.callServerMethod(this,r.name,r.endpoint,o)};r.debounce?t=p.debounce(t,r.debounce,r.debounce_immediate):r.throttle&&(t=p.throttle(t,r.throttle,{leading:r.throttle_leading,trailing:r.throttle_trailing})),s[r.name]=t}),s},makeAlpineComponent(e,s,r,t){Alpine.data(e,o=>{let{init:i,destroy:c,...n}=s,a=p.jsonDecode(o);return{componentName:e,__initInner:i,__destroyInner:c,__serverMethods:r,__serverProperties:t,__serverStores:a==null?void 0:a.__serverStores,...a||{},...n,...p.makeServerMethods(r),...p.alpineComponentMixins()}})},getStateWithChildren(e){let s={};e.__serverProperties.forEach(t=>{s[t]=e[t]}),e.__serverStores&&(s.__serverStores=e.__serverStores);let r={encrypted:e.__state,data:s,children:[]};for(let t in e.__childComponents){let o=e.__childComponents[t];r.children.push(p.getStateWithChildren(o))}return r},loadScript(e){return new Promise((s,r)=>{let t=document.createElement("script");t.src=e,t.onload=s,t.onerror=r,document.head.appendChild(t)})},loadStyles(e){return new Promise((s,r)=>{let t=document.createElement("link");t.href=e,t.rel="stylesheet",t.type="text/css",t.onload=s,t.onerror=r,document.head.appendChild(t)})},getFilenameFromContentDisposition(e){if(!e)return null;let s=/filename\*=([^']*)'([^']*)'([^;]*)/i.exec(e);if(s)try{return decodeURIComponent(s[3])}catch(r){console.warn("Error decoding filename:",r)}return s=/filename=["']?([^"';\n]*)["']?/i.exec(e),s?s[1]:null},async handleServerMethodResponse(e,s){if(e.status===200){let r=e.headers.get("Content-Disposition");if(r!=null&&r.startsWith("attachment")){let h=document.createElement("a");h.href=URL.createObjectURL(await e.blob()),h.download=this.getFilenameFromContentDisposition(r),h.click(),h.remove();return}let t=await e.text(),o=p.jsonDecode(t),i=!1,c=null,n=null,a=[],d=[],l=[],_=[];if(o.protocol!=="tetra-1.0")throw new Error("Invalid or missing Tetra protocol in server response");if(i=o.success,o.payload&&(c=o.payload.result,n=o.payload.html),o.metadata){a=o.metadata.js||[],d=o.metadata.styles||[],l=o.metadata.messages||[],_=o.metadata.callbacks||[];let h=_.find(u=>u.callback&&u.callback.length===1&&u.callback[0]==="_redirect");if(h&&h.args&&h.args.length>0){document.location=h.args[0];return}}if(!i&&o.error&&(console.error(`Tetra method error [${o.error.code}]: ${o.error.message}`),document.dispatchEvent(new CustomEvent("tetra:method-error",{detail:{component:s,error:o.error}}))),l&&l.forEach(h=>{s.$dispatch("tetra:new-message",h)}),i){let h=[];return a.forEach(u=>{document.querySelector(`script[src="${CSS.escape(u)}"]`)||h.push(p.loadScript(u))}),d.forEach(u=>{document.querySelector(`link[href="${CSS.escape(u)}"]`)||h.push(p.loadStyles(u))}),await Promise.all(h),n&&s._updateHtml(n),_&&_.forEach(u=>{let f=s;u.callback.forEach((b,g)=>{g===u.callback.length-1?f[b](...u.args):f=f[b]})}),c}else throw o.error?new Error(`Error processing public method: ${o.error.message}`):new Error("Error processing public method")}else throw new Error(`Server responded with an error ${e.status} (${e.statusText})`)},async callServerMethod(e,s,r,t){let o=Math.random().toString(36).substring(2,15),i=p.getStateWithChildren(e);i.args=t||[];let c={protocol:"tetra-1.0",id:o,type:"call",payload:{component_id:e.$el.getAttribute("tetra-component-id"),method:s,args:i.args,state:i.data,encrypted_state:i.encrypted,children_state:i.children}},n={method:"POST",headers:{"T-Request":"true","T-Current-URL":document.location.href,"X-CSRFToken":window.__tetra_csrfToken},mode:"same-origin"},a=new FormData,d=!1;for(let[u,f]of Object.entries(i.data))f instanceof File&&(d=!0,c.payload.state[u]={},a.append(u,f));d?(a.append("tetra_payload",p.jsonEncode(c)),n.body=a):(n.body=p.jsonEncode(c),n.headers["Content-Type"]="application/json");let l=e.$event?e.$event.target:e.$el;e.$dispatch("tetra:before-request",{component:e,triggerEl:l,requestId:o});let _=await fetch(r,n);return e.$dispatch("tetra:after-request",{component:e,triggerEl:l,requestId:o}),await this.handleServerMethodResponse(_,e)},jsonReplacer(e,s){return s instanceof Date?{__type:"datetime",value:s.toISOString()}:s instanceof Set?{__type:"set",value:Array.from(s)}:s},jsonReviver(e,s){if(s&&typeof s=="object"&&s.__type){if(s.__type==="datetime")return new Date(s);if(s.__type==="set")return new Set(s)}return s},jsonEncode(e){return JSON.stringify(e,p.jsonReplacer)},jsonDecode(e){return JSON.parse(e,p.jsonReviver)},debounce(e,s,r){var t;return function(){var o=this,i=arguments,c=function(){t=null,r||e.apply(o,i)},n=r&&!t;clearTimeout(t),t=setTimeout(c,s),n&&e.apply(o,i)}},throttle(e,s,r){var t,o,i,c,n=0;r||(r={});var a=function(){n=r.leading===!1?0:Date.now(),t=null,c=e.apply(o,i),t||(o=i=null)},d=function(){var l=Date.now();!n&&r.leading===!1&&(n=l);var _=s-(l-n);return o=this,i=arguments,_<=0||_>s?(t&&(clearTimeout(t),t=null),n=l,c=e.apply(o,i),t||(o=i=null)):!t&&r.trailing!==!1&&(t=setTimeout(a,_)),c};return d.cancel=function(){clearTimeout(t),n=0,t=o=i=null},d}},m=p;window.Tetra=m;window.document.addEventListener("alpine:init",()=>{m.init()});})();
//# sourceMappingURL=tetra.min.js.map
