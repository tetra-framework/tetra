(()=>{var l={ws:null,pendingSubscriptions:new Map,debug(...e){window.__tetra_debug&&console.debug(...e)},init(){Alpine.magic("static",()=>l.$static),window.__tetra_useWebsockets&&this.ensureWebSocketConnection(),window.__tetra_messages&&(this.handleInitialMessages(window.__tetra_messages),delete window.__tetra_messages),Alpine.store("tetra_subscriptions")||Alpine.store("tetra_subscriptions",{}),this.initOnlineStatusStore()},initOnlineStatusStore(){if(this.onlineStatusInitialized)return;this.onlineStatusInitialized=!0;let e=window.__tetra_onlineTimeout||1e4;typeof Alpine<"u"&&(Alpine.store("tetra_status")||Alpine.store("tetra_status",{online:!0,lastActivity:Date.now(),update(){this.online=!0,this.lastActivity=Date.now()}})),this.offlineTimeout&&clearTimeout(this.offlineTimeout),this.offlineTimeout=setTimeout(()=>this.checkOnlineStatus(),e),document.addEventListener("tetra:websocket-connected",()=>this.updateOnlineStatus())},updateOnlineStatus(){if(typeof Alpine<"u"){let t=Alpine.store("tetra_status");t&&t.update()}this.offlineTimeout&&clearTimeout(this.offlineTimeout);let e=window.__tetra_onlineTimeout||1e4;this.offlineTimeout=setTimeout(()=>this.checkOnlineStatus(),e),this.pingTimeout&&clearTimeout(this.pingTimeout)},checkOnlineStatus(){if(this.pingTimeout&&clearTimeout(this.pingTimeout),this.ws&&this.ws.readyState===WebSocket.OPEN){this.ws.send(JSON.stringify({protocol:"tetra-1.0",type:"ping"}));let e=window.__tetra_pingTimeout||5e3;this.pingTimeout=setTimeout(()=>this.setOfflineStatus(),e)}else this.setOfflineStatus()},setOfflineStatus(){if(typeof Alpine<"u"){let e=Alpine.store("tetra_status");e&&(e.online=!1,document.dispatchEvent(new CustomEvent("tetra:websocket-disconnected")))}},handleInitialMessages(e){e.forEach(t=>{document.dispatchEvent(new CustomEvent("tetra:new-message",{detail:t,bubbles:!0}))})},$static(){return e=>window.__tetra_staticRoot+e},ensureWebSocketConnection(){if(!this.ws||this.ws.readyState===WebSocket.CLOSED){console.log("Connecting to Tetra WebSocket...");let t=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws/tetra/`;this.ws=new WebSocket(t),this.ws.onopen=()=>{l.debug("Tetra WebSocket connected"),this.updateOnlineStatus(),document.dispatchEvent(new CustomEvent("tetra:websocket-connected")),this.pendingSubscriptions.forEach((i,s)=>{this.ws.send(JSON.stringify(i))}),this.pendingSubscriptions.clear()},this.ws.onmessage=i=>{this.updateOnlineStatus();let s=JSON.parse(i.data);if(s.type==="pong"){this.pingTimeout&&clearTimeout(this.pingTimeout);return}this.handleWebsocketMessage(s)},this.ws.onclose=()=>{console.log("Tetra WebSocket disconnected"),this.setOfflineStatus(),setTimeout(()=>{this.ensureWebSocketConnection()},3e3)},this.ws.onerror=i=>{console.error("Tetra WebSocket error:",i)}}return this.ws},_get_component_by_id(e){let t=document.querySelector(`[tetra-component-id="${e}"]`);if(t)return Alpine.$data(t)},_get_components_by_subscribe_group(e){let s=(Alpine.store("tetra_subscriptions")[e]||[]).map(n=>this._get_component_by_id(n)).filter(n=>!!n&&typeof n._removeComponent=="function");return[...new Set(s)]},handleWebsocketMessage(e){let t,i,s={};if(e.protocol!=="tetra-1.0"){console.warn("Invalid or missing Tetra protocol in WebSocket message:",e);return}switch(t=e.type,i=e.payload,s=e.metadata||{},t){case"subscription.response":this.handleSubscriptionResponse(i);break;case"notify":this.handleGroupNotify(i);break;case"component.data_changed":this.handleComponentDataChanged(i);break;case"component.removed":this.handleComponentRemoved(i);break;case"component.created":this.handleComponentCreated(i);break;default:console.warn("Unknown WebSocket message type:",t,":",e)}},handleSubscriptionResponse(e){switch(e.status){case"subscribed":l.debug("Subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-subscribed",{detail:{component:this,group:e.group}}));break;case"unsubscribed":l.debug("Subscription to group",e.group,"redacted successfully."),document.dispatchEvent(new CustomEvent("tetra:component-unsubscribed",{detail:{component:this,group:e.group}}));break;case"resubscribed":l.debug("Re-subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-resubscribed",{detail:{component:this,group:e.group}}));break;case"error":console.error("Error subscribing component",e.component_id,"to group",e.group,":",e.message),document.dispatchEvent(new CustomEvent("tetra:component-subscription-error",{detail:{component:this,group:e.group,message:e.message}}));break;default:l.debug("Subscription response faulty:",e)}},handleGroupNotify(e){let{group:t,event_name:i,data:s}=e;document.dispatchEvent(new CustomEvent(i,{detail:{data:s,group:t}}))},handleComponentDataChanged(e){let{group:t,data:i,sender_id:s,update:n}=e,o=this._get_components_by_subscribe_group(t);o.length===0&&document.querySelectorAll(`[tetra-subscription="${t}"]`).forEach(r=>{let a=Alpine.$data(r);a&&!o.includes(a)&&o.push(a)}),o.forEach(c=>{s&&c.__activeRequests&&c.__activeRequests.has(s)||(i&&Object.keys(i).length>0&&c._updateData(i),(n||!i||Object.keys(i).length===0)&&c._updateHtml().catch(r=>{console.error("Error updating component HTML:",r)}))})},handleComponentRemoved(e){let{type:t,group:i,component_id:s,target_group:n,sender_id:o}=e;if(s){let r=this._get_component_by_id(s);if(r&&r._removeComponent){if(o&&r.__activeRequests&&r.__activeRequests.has(o))return;r._removeComponent()}return}if(n){let r=this._get_components_by_subscribe_group(n);r.length===0&&document.querySelectorAll(`[tetra-subscription="${n}"]`).forEach(d=>{let u=Alpine.$data(d);u&&u._removeComponent&&u._removeComponent()}),r.forEach(a=>{if(a&&a._removeComponent){if(o&&a.__activeRequests&&a.__activeRequests.has(o))return;a._removeComponent()}});return}let c=this._get_components_by_subscribe_group(i);c.length===0&&document.querySelectorAll(`[tetra-subscription="${i}"]`).forEach(a=>{let d=Alpine.$data(a);d&&d._removeComponent&&d._removeComponent()}),c.forEach(r=>{if(r&&r._removeComponent){if(o&&r.__activeRequests&&r.__activeRequests.has(o))return;r._removeComponent()}})},handleComponentCreated(e){let{group:t,data:i,component_id:s,target_group:n,sender_id:o}=e;this._get_components_by_subscribe_group(t).forEach(r=>{o&&r.__activeRequests&&r.__activeRequests.has(o)||r._updateHtml().catch(a=>{console.error("Error updating component HTML after creation:",a)})})},sendWebSocketMessage(e){if(!this.ws){console.log("WebSocket is not connected. Cannot send message.");return}this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):(e.type==="subscribe"&&e.component_id&&this.pendingSubscriptions.set(e.component_id,e),this.ws.addEventListener("open",()=>{this.ws.send(JSON.stringify(e))},{once:!0}))},alpineComponentMixins(){return{init(){if(this.component_id=this.$el.getAttribute("tetra-component-id"),this.$dispatch("tetra:child-component-init",{component:this}),this.__initServerWatchers(),this.__initStores(),window.__tetra_useWebsockets&&this.$el.hasAttribute("tetra-reactive")){l.ensureWebSocketConnection();let s=this.$el.getAttribute("tetra-subscription");s&&this._subscribe(s)}this.__initInner&&this.__initInner(),this._handleAutofocus();let e=()=>{[this.$el,...Array.from(this.$el.querySelectorAll("[t-indicator]"))].forEach(n=>{let o=n.getAttribute("t-indicator");o&&document.querySelectorAll(o).forEach(c=>{c.getAttribute("hidden")===null&&(c.hidden=!0),c.classList.add("tetra-indicator-"+this.component_id)})})};e(),this.$el.addEventListener("tetra:component-updated",e);let t=(s,n)=>{let o=s.detail.triggerEl||s.target,c=s.detail.requestId;if(!this.$el.contains(o)&&this.$el!==o)return;if(this.__activeRequests||(this.__activeRequests=new Map),n){let u="";o.id&&(u="#"+o.id),this.__activeRequests.set(c,{triggerSelector:u,indicatorSelector:o.getAttribute("t-indicator"),completed:!1})}else{let u=this.__activeRequests.get(c);u&&(u.completed=!0),setTimeout(()=>{this.__activeRequests.delete(c)},500)}let r=(u,_,p)=>(u.__activeRequests||(u.__activeRequests=new Set),p?u.__activeRequests.add(_):u.__activeRequests.delete(_),u.__activeRequests.size>0),a=r(o,c,n);o.classList.toggle("tetra-request",a);let d=o.getAttribute("t-indicator");if(d){let u=Array.from(this.$el.querySelectorAll(d)),_=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),p=new Set(u);_.forEach(h=>{h.matches(d)&&p.add(h)}),p.forEach(h=>{r(h,c,n)?(h.removeAttribute("hidden"),h.hidden=!1):(h.setAttribute("hidden",""),h.hidden=!0)})}},i=()=>{!this.__activeRequests||this.__activeRequests.size===0||this.__activeRequests.forEach((s,n)=>{if(!s.completed&&(s.triggerSelector&&this.$el.querySelectorAll(s.triggerSelector).forEach(c=>{c.__activeRequests||(c.__activeRequests=new Set),c.__activeRequests.add(n),c.classList.add("tetra-request")}),s.indicatorSelector)){let o=Array.from(this.$el.querySelectorAll(s.indicatorSelector)),c=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),r=new Set(o);c.forEach(a=>{a.matches(s.indicatorSelector)&&r.add(a)}),r.forEach(a=>{a.__activeRequests||(a.__activeRequests=new Set),a.__activeRequests.add(n),a.removeAttribute("hidden"),a.hidden=!1})}})};this.$el.addEventListener("tetra:before-request",s=>t(s,!0)),this.$el.addEventListener("tetra:after-request",s=>t(s,!1)),this.$el.addEventListener("tetra:component-updated",i)},destroy(){this.$dispatch("tetra:child-component-destroy",{component:this}),!this.__isUpdating&&this.__subscribedGroups&&[...this.__subscribedGroups].forEach(e=>{this._unsubscribe(e)}),this.__destroyInner&&this.__destroyInner()},async _updateHtml(e){if(e||(e=await this._fetchHtml()),this.__isUpdating=!0,Alpine.morph(this.$root,e,{updating(t,i,s,n){if(i.hasAttribute&&i.hasAttribute("x-data-maintain")&&t.hasAttribute&&t.hasAttribute("x-data"))i.setAttribute("x-data",t.getAttribute("x-data")),i.removeAttribute("x-data-maintain");else if(i.hasAttribute&&i.hasAttribute("x-data-update")&&t.hasAttribute&&t.hasAttribute("x-data")){let o=l.jsonDecode(i.getAttribute("x-data-update")),c=l.jsonDecode(i.getAttribute("x-data-update-old")),r=window.Alpine.$data(t);for(let a in o)c.hasOwnProperty(a)&&c[a]!==r[a]||(r[a]=o[a]);i.setAttribute("x-data",t.getAttribute("x-data")),i.removeAttribute("x-data-update")}},lookahead:!0}),this.__isUpdating=!1,window.__tetra_useWebsockets&&this.$el.hasAttribute("tetra-reactive")){let t=this.$el.getAttribute("tetra-subscription");(this.__subscribedGroups?Array.from(this.__subscribedGroups):[]).forEach(s=>{s!==t&&this._unsubscribe(s)}),t&&(!this.__subscribedGroups||!this.__subscribedGroups.has(t))&&this._subscribe(t)}this._handleAutofocus(),this.$dispatch("tetra:component-updated",{component:this})},_updateData(e){let t=document.activeElement,i=null;if(t&&(t.tagName==="INPUT"||t.tagName==="TEXTAREA"||t.tagName==="SELECT")&&this.$el.contains(t)&&(i=t.getAttribute("x-model"),!i)){let s=t.parentElement;for(;s&&s!==this.$el&&!i;)i=s.getAttribute("x-model"),s=s.parentElement}for(let s in e){if(i===s){l.debug(`Skipping update for focused field: ${s}`);continue}this[s]=e[s]}this.$dispatch("tetra:component-data-updated",{component:this})},_setValueByName(e,t){let i=document.getElementsByName(e);for(let s=0;s<i.length;s++)i[s].value=t},_removeComponent(){this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.remove(),l.debug(`Removed component with key ${this.key} and ID ${this.component_id}`)},_replaceComponent(e){this.__isUpdating=!0,this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.insertAdjacentHTML("afterend",e),this.$root.remove(),this.__isUpdating=!1,this.$dispatch("tetra:component-updated",{component:this}),this._handleAutofocus(),l.debug(`Replaced component with key ${this.key} and ID ${this.component_id}`)},_redirect(e){document.location=e},_dispatch(e,t){this.$dispatch(e,{_component:this,...t})},_pushUrl(e,t=!1){t?window.history.replaceState(null,"",e):window.history.pushState(null,"",e)},_updateSearchParam(e,t){let i=new URL(window.location);t?i.searchParams.set(e,t):i.searchParams.delete(e),window.history.pushState(null,"",i.toString())},_handleAutofocus(){this.$nextTick(()=>{if(!this.$root)return;let e=this.$root.querySelector("[autofocus]");e&&e.focus()})},async _fetchHtml(){var s;let e=(s=this.__serverMethods)==null?void 0:s.find(n=>n.name==="_refresh");if(!e)throw new Error("_refresh method endpoint not found in component server methods");let t=e.endpoint[0],i=await l.callServerMethod(this,"_refresh",t,[]);return(i==null?void 0:i.html)||i},_subscribe(e){this.__subscribedGroups||(this.__subscribedGroups=new Set);let t=Alpine.store("tetra_subscriptions");if(this.__subscribedGroups.add(e),t[e]||(t[e]=[]),!t[e].includes(this.component_id)){let i=t[e].length===0;t[e].push(this.component_id),i&&l.sendWebSocketMessage({type:"subscribe",group:e,component_id:this.component_id,component_class:this.componentName})}},_unsubscribe(e){if(!this.__subscribedGroups)return;let t=Alpine.store("tetra_subscriptions");if(this.__subscribedGroups.delete(e),t[e]){let i=t[e].indexOf(this.component_id);i>-1&&(t[e].splice(i,1),t[e].length===0&&(delete t[e],l.sendWebSocketMessage({type:"unsubscribe",group:e,component_id:this.component_id})))}},_notifyGroup(e,t,i){return l.sendWebSocketMessage({type:"notify",group:e,event_name:t,data:i,sender_id:this.component_id})},__initServerWatchers(){this.__serverMethods.forEach(e=>{e.watch&&e.watch.forEach(t=>{this.$watch(t,async(i,s)=>{await this[e.name](i,s,t)})})})},__initStores(){this.__serverStores&&Object.entries(this.__serverStores).forEach(([e,t])=>{let i=t.split("."),s=i[0],n=i.slice(1);Alpine.store(s)||Alpine.store(s,{});let o=()=>{let d=Alpine.store(s);for(let u of n){if(d==null||typeof d!="object")return;d=d[u]}return d},c=d=>{if(n.length===0)Alpine.store(s)!==d&&Alpine.store(s,d);else{let u=Alpine.store(s);for(let p=0;p<n.length-1;p++){let h=n[p];(!(h in u)||typeof u[h]!="object")&&(u[h]={}),u=u[h]}let _=n[n.length-1];u[_]!==d&&(u[_]=d)}},r=o();Alpine.effect(()=>{let d=o();d!==r&&d!==void 0&&(r=d,this[e]!==d&&(this.__isSyncingFromStore=e,this[e]=d,this.$nextTick(()=>{this.__isSyncingFromStore===e&&(this.__isSyncingFromStore=null)})))}),this.$watch(e,d=>{this.__isSyncingFromStore!==e&&o()!==d&&(c(d),r=d)});let a=o();a!==void 0?(this[e]=a,r=a):(c(this[e]),r=this[e])})},__childComponents:{},__rootBind:{"@tetra:child-component-init"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(t.key&&(this.__childComponents[t.key]=t),t._parent=this)},"@tetra:child-component-destroy"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(delete this.__childComponents[t.key],e.detail.component._parent=null)}}}},makeServerMethods(e){let t={};return e.forEach(i=>{var s=async function(...n){return await l.callServerMethod(this,i.name,i.endpoint,n)};i.debounce?s=l.debounce(s,i.debounce,i.debounce_immediate):i.throttle&&(s=l.throttle(s,i.throttle,{leading:i.throttle_leading,trailing:i.throttle_trailing})),t[i.name]=s}),t},makeAlpineComponent(e,t,i,s){Alpine.data(e,n=>{let{init:o,destroy:c,...r}=t,a=l.jsonDecode(n);return{componentName:e,__initInner:o,__destroyInner:c,__serverMethods:i,__serverProperties:s,__serverStores:a==null?void 0:a.__serverStores,...a||{},...r,...l.makeServerMethods(i),...l.alpineComponentMixins()}})},getStateWithChildren(e){let t={};e.__serverProperties.forEach(s=>{t[s]=e[s]}),e.__serverStores&&(t.__serverStores=e.__serverStores);let i={encrypted:e.__state,data:t,children:[]};for(let s in e.__childComponents){let n=e.__childComponents[s];i.children.push(l.getStateWithChildren(n))}return i},loadScript(e){return new Promise((t,i)=>{let s=document.createElement("script");s.src=e,s.onload=t,s.onerror=i,document.head.appendChild(s)})},loadStyles(e){return new Promise((t,i)=>{let s=document.createElement("link");s.href=e,s.rel="stylesheet",s.type="text/css",s.onload=t,s.onerror=i,document.head.appendChild(s)})},getFilenameFromContentDisposition(e){if(!e)return null;let t=/filename\*=([^']*)'([^']*)'([^;]*)/i.exec(e);if(t)try{return decodeURIComponent(t[3])}catch(i){console.warn("Error decoding filename:",i)}return t=/filename=["']?([^"';\n]*)["']?/i.exec(e),t?t[1]:null},async handleServerMethodResponse(e,t){if(e.status===200){let i=e.headers.get("Content-Disposition");if(i!=null&&i.startsWith("attachment")){let p=document.createElement("a");p.href=URL.createObjectURL(await e.blob()),p.download=this.getFilenameFromContentDisposition(i),p.click(),p.remove();return}let s=await e.text(),n=l.jsonDecode(s),o=!1,c=null,r=null,a=[],d=[],u=[],_=[];if(n.protocol!=="tetra-1.0")throw new Error("Invalid or missing Tetra protocol in server response");if(o=n.success,n.payload&&(c=n.payload.result,r=n.payload.html),n.metadata){a=n.metadata.js||[],d=n.metadata.styles||[],u=n.metadata.messages||[],_=n.metadata.callbacks||[];let p=_.find(h=>h.callback&&h.callback.length===1&&h.callback[0]==="_redirect");if(p&&p.args&&p.args.length>0){document.location=p.args[0];return}}if(!o&&n.error&&(console.error(`Tetra method error [${n.error.code}]: ${n.error.message}`),document.dispatchEvent(new CustomEvent("tetra:method-error",{detail:{component:t,error:n.error}}))),u&&u.forEach(p=>{t.$dispatch("tetra:new-message",p)}),o){let p=[];return a.forEach(h=>{document.querySelector(`script[src="${CSS.escape(h)}"]`)||p.push(l.loadScript(h))}),d.forEach(h=>{document.querySelector(`link[href="${CSS.escape(h)}"]`)||p.push(l.loadStyles(h))}),await Promise.all(p),r&&t._updateHtml(r),_&&_.forEach(h=>{let f=t;h.callback.forEach((g,b)=>{b===h.callback.length-1?f[g](...h.args):f=f[g]})}),c}else throw n.error?new Error(`Error processing public method: ${n.error.message}`):new Error("Error processing public method")}else throw new Error(`Server responded with an error ${e.status} (${e.statusText})`)},async callServerMethod(e,t,i,s){let n=Math.random().toString(36).substring(2,15),o=l.getStateWithChildren(e);o.args=s||[];let c={protocol:"tetra-1.0",id:n,type:"call",payload:{component_id:e.$el.getAttribute("tetra-component-id"),method:t,args:o.args,state:o.data,encrypted_state:o.encrypted,children_state:o.children}},r={method:"POST",headers:{"T-Request":"true","T-Current-URL":document.location.href,"X-CSRFToken":window.__tetra_csrfToken},mode:"same-origin"},a=new FormData,d=!1;for(let[h,f]of Object.entries(o.data))f instanceof File&&(d=!0,c.payload.state[h]={},a.append(h,f));d?(a.append("tetra_payload",l.jsonEncode(c)),r.body=a):(r.body=l.jsonEncode(c),r.headers["Content-Type"]="application/json");let u=e.$event?e.$event.target:e.$el;e.$dispatch("tetra:before-request",{component:e,triggerEl:u,requestId:n}),this.updateOnlineStatus();let _=await fetch(i,r);return e.$dispatch("tetra:after-request",{component:e,triggerEl:u,requestId:n}),await this.handleServerMethodResponse(_,e)},jsonReplacer(e,t){return t instanceof Date?{__type:"datetime",value:t.toISOString()}:t instanceof Set?{__type:"set",value:Array.from(t)}:t},jsonReviver(e,t){if(t&&typeof t=="object"&&t.__type){if(t.__type==="datetime")return new Date(t);if(t.__type==="set")return new Set(t)}return t},jsonEncode(e){return JSON.stringify(e,l.jsonReplacer)},jsonDecode(e){return JSON.parse(e,l.jsonReviver)},debounce(e,t,i){var s;return function(){var n=this,o=arguments,c=function(){s=null,i||e.apply(n,o)},r=i&&!s;clearTimeout(s),s=setTimeout(c,t),r&&e.apply(n,o)}},throttle(e,t,i){var s,n,o,c,r=0;i||(i={});var a=function(){r=i.leading===!1?0:Date.now(),s=null,c=e.apply(n,o),s||(n=o=null)},d=function(){var u=Date.now();!r&&i.leading===!1&&(r=u);var _=t-(u-r);return n=this,o=arguments,_<=0||_>t?(s&&(clearTimeout(s),s=null),r=u,c=e.apply(n,o),s||(n=o=null)):!s&&i.trailing!==!1&&(s=setTimeout(a,_)),c};return d.cancel=function(){clearTimeout(s),r=0,s=n=o=null},d}},m=l;window.Tetra=m;window.document.addEventListener("alpine:init",()=>{m.init()});})();
//# sourceMappingURL=tetra.min.js.map
