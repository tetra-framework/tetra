(()=>{var p={ws:null,pendingSubscriptions:new Map,init(){Alpine.magic("static",()=>p.$static),window.__tetra_useWebsockets&&this.ensureWebSocketConnection(),window.__tetra_messages&&(this.handleInitialMessages(window.__tetra_messages),delete window.__tetra_messages)},handleInitialMessages(e){e.forEach(t=>{document.dispatchEvent(new CustomEvent("tetra:new-message",{detail:t,bubbles:!0}))})},$static(){return e=>window.__tetra_staticRoot+e},ensureWebSocketConnection(){if(!this.ws||this.ws.readyState===WebSocket.CLOSED){console.log("Connecting to Tetra WebSocket...");let t=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws/tetra/`;this.ws=new WebSocket(t),this.ws.onopen=()=>{console.debug("Tetra WebSocket connected"),this.pendingSubscriptions.forEach((r,s)=>{this.ws.send(JSON.stringify(r))}),this.pendingSubscriptions.clear()},this.ws.onmessage=r=>{let s=JSON.parse(r.data);this.handleWebsocketMessage(s)},this.ws.onclose=()=>{console.log("Tetra WebSocket disconnected"),setTimeout(()=>{this.ensureWebSocketConnection()},3e3)},this.ws.onerror=r=>{console.error("Tetra WebSocket error:",r)}}return this.ws},_get_component_by_id(e){let t=document.querySelector(`[tetra-component-id="${e}"]`);if(!t){console.error(`AlpineJs Component with ID ${e} not found.`);return}return Alpine.$data(t)},_get_components_by_subscribe_group(e){let t=document.querySelectorAll("[tetra-subscription]");return Array.from(t).filter(s=>s.getAttribute("tetra-subscription").split(",").map(i=>i.trim()).includes(e)).map(s=>Alpine.$data(s))},handleWebsocketMessage(e){let t,r,s={};if(e.protocol!=="tetra-1.0"){console.warn("Invalid or missing Tetra protocol in WebSocket message:",e);return}switch(t=e.type,r=e.payload,s=e.metadata||{},t){case"subscription.response":this.handleSubscriptionResponse(r);break;case"notify":this.handleGroupNotify(r);break;case"component.update_data":this.handleComponentUpdateData(r);break;case"component.remove":this.handleComponentRemove(r);break;default:console.warn("Unknown WebSocket message type:",t,":",e)}},handleSubscriptionResponse(e){switch(e.status){case"subscribed":console.debug("Subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-subscribed",{detail:{component:this,group:e.group}}));break;case"unsubscribed":console.debug("Subscription to group",e.group,"redacted successfully."),document.dispatchEvent(new CustomEvent("tetra:component-unsubscribed",{detail:{component:this,group:e.group}}));break;case"resubscribed":console.debug("Re-subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-resubscribed",{detail:{component:this,group:e.group}}));break;case"error":console.error("Error subscribing component",e.component_id,"to group",e.group,":",e.message),document.dispatchEvent(new CustomEvent("tetra:component-subscription-error",{detail:{component:this,group:e.group,message:e.message}}));break;default:console.debug("Subscription response faulty:",e)}},handleGroupNotify(e){let{group:t,event_name:r,data:s}=e;document.dispatchEvent(new CustomEvent(r,{detail:{data:s,group:t}}))},handleComponentUpdateData(e){let{group:t,data:r,sender_id:s}=e;this._get_components_by_subscribe_group(t).forEach(n=>{s&&n.__activeRequests&&n.__activeRequests.has(s)||n._updateData(r)})},handleComponentRemove(e){let{type:t,group:r,component_id:s}=e,o=this._get_component_by_id(s);o&&o._removeComponent?o._removeComponent():(o.remove(),console.debug("Element with ID ${component_id} not identified as Alpine component, just removed it anyway."))},sendWebSocketMessage(e){if(!this.ws){console.log("WebSocket is not connected. Cannot send message.");return}this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):(e.type==="subscribe"&&e.component_id&&this.pendingSubscriptions.set(e.component_id,e),this.ws.addEventListener("open",()=>{this.ws.send(JSON.stringify(e))},{once:!0}))},alpineComponentMixins(){return{init(){if(this.component_id=this.$el.getAttribute("tetra-component-id"),this.$dispatch("tetra:child-component-init",{component:this}),this.__initServerWatchers(),this.__initStores(),window.__tetra_useWebsockets&&this.$el.hasAttribute("tetra-reactive")){p.ensureWebSocketConnection();let s=this.$el.getAttribute("tetra-subscription");s&&this._subscribe(s)}this.__initInner&&this.__initInner(),this._handleAutofocus();let e=()=>{[this.$el,...Array.from(this.$el.querySelectorAll("[t-indicator]"))].forEach(o=>{let n=o.getAttribute("t-indicator");n&&document.querySelectorAll(n).forEach(i=>{i.getAttribute("hidden")===null&&(i.hidden=!0),i.classList.add("tetra-indicator-"+this.component_id)})})};e(),this.$el.addEventListener("tetra:component-updated",e);let t=(s,o)=>{let n=s.detail.triggerEl||s.target,i=s.detail.requestId;if(!this.$el.contains(n)&&this.$el!==n)return;if(this.__activeRequests||(this.__activeRequests=new Map),o){let c="";n.id&&(c="#"+n.id),this.__activeRequests.set(i,{triggerSelector:c,indicatorSelector:n.getAttribute("t-indicator"),completed:!1})}else{let c=this.__activeRequests.get(i);c&&(c.completed=!0),setTimeout(()=>{this.__activeRequests.delete(i)},5e3)}let l=(c,u,h)=>(c.__activeRequests||(c.__activeRequests=new Set),h?c.__activeRequests.add(u):c.__activeRequests.delete(u),c.__activeRequests.size>0),d=l(n,i,o);n.classList.toggle("tetra-request",d);let a=n.getAttribute("t-indicator");if(a){let c=Array.from(this.$el.querySelectorAll(a)),u=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),h=new Set(c);u.forEach(_=>{_.matches(a)&&h.add(_)}),h.forEach(_=>{l(_,i,o)?(_.removeAttribute("hidden"),_.hidden=!1):(_.setAttribute("hidden",""),_.hidden=!0)})}},r=()=>{!this.__activeRequests||this.__activeRequests.size===0||this.__activeRequests.forEach((s,o)=>{if(!s.completed&&(s.triggerSelector&&this.$el.querySelectorAll(s.triggerSelector).forEach(i=>{i.__activeRequests||(i.__activeRequests=new Set),i.__activeRequests.add(o),i.classList.add("tetra-request")}),s.indicatorSelector)){let n=Array.from(this.$el.querySelectorAll(s.indicatorSelector)),i=Array.from(document.querySelectorAll(".tetra-indicator-"+this.component_id)),l=new Set(n);i.forEach(d=>{d.matches(s.indicatorSelector)&&l.add(d)}),l.forEach(d=>{d.__activeRequests||(d.__activeRequests=new Set),d.__activeRequests.add(o),d.removeAttribute("hidden"),d.hidden=!1})}})};this.$el.addEventListener("tetra:before-request",s=>t(s,!0)),this.$el.addEventListener("tetra:after-request",s=>t(s,!1)),this.$el.addEventListener("tetra:component-updated",r)},destroy(){this.$dispatch("tetra:child-component-destroy",{component:this}),this.__subscribedGroups&&this.__subscribedGroups.forEach(e=>{this._unsubscribe(e)}),this.__destroyInner&&this.__destroyInner()},_updateHtml(e){Alpine.morph(this.$root,e,{updating(t,r,s,o){if(r.hasAttribute&&r.hasAttribute("x-data-maintain")&&t.hasAttribute&&t.hasAttribute("x-data"))r.setAttribute("x-data",t.getAttribute("x-data")),r.removeAttribute("x-data-maintain");else if(r.hasAttribute&&r.hasAttribute("x-data-update")&&t.hasAttribute&&t.hasAttribute("x-data")){let n=p.jsonDecode(r.getAttribute("x-data-update")),i=p.jsonDecode(r.getAttribute("x-data-update-old")),l=window.Alpine.$data(t);for(let d in n)i.hasOwnProperty(d)&&i[d]!==l[d]||(l[d]=n[d]);r.setAttribute("x-data",t.getAttribute("x-data")),r.removeAttribute("x-data-update")}},lookahead:!0}),this._handleAutofocus(),this.$dispatch("tetra:component-updated",{component:this})},_updateData(e){for(let t in e)this[t]=e[t];this.$dispatch("tetra:component-data-updated",{component:this})},_setValueByName(e,t){let r=document.getElementsByName(e);for(let s=0;s<r.length;s++)r[s].value=t},_removeComponent(){this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.remove()},_replaceComponent(e){this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.insertAdjacentHTML("afterend",e),this.$root.remove(),this.$dispatch("tetra:component-updated",{component:this}),this._handleAutofocus()},_redirect(e){document.location=e},_dispatch(e,t){this.$dispatch(e,{_component:this,...t})},_pushUrl(e,t=!1){t?window.history.replaceState(null,"",e):window.history.pushState(null,"",e)},_updateSearchParam(e,t){let r=new URL(window.location);t?r.searchParams.set(e,t):r.searchParams.delete(e),window.history.pushState(null,"",r.toString())},_handleAutofocus(){this.$nextTick(()=>{if(!this.$root)return;let e=this.$root.querySelector("[autofocus]");e&&e.focus()})},_subscribe(e,t=!0){return this.__subscribedGroups||(this.__subscribedGroups=new Set),this.__subscribedGroups.add(e),p.sendWebSocketMessage({type:"subscribe",group:e,component_id:this.component_id,component_class:this.componentName,auto_update:t})},_unsubscribe(e){return this.__subscribedGroups&&this.__subscribedGroups.delete(e),p.sendWebSocketMessage({type:"unsubscribe",group:e,component_id:this.component_id})},_notifyGroup(e,t,r){return p.sendWebSocketMessage({type:"notify",group:e,event_name:t,data:r,sender_id:this.component_id})},__initServerWatchers(){this.__serverMethods.forEach(e=>{e.watch&&e.watch.forEach(t=>{this.$watch(t,async(r,s)=>{await this[e.name](r,s,t)})})})},__initStores(){this.__serverStores&&Object.entries(this.__serverStores).forEach(([e,t])=>{let r=t.split("."),s=r[0],o=r.slice(1);Alpine.store(s)||Alpine.store(s,{});let n=()=>{let a=Alpine.store(s);for(let c of o){if(a==null||typeof a!="object")return;a=a[c]}return a},i=a=>{if(o.length===0)Alpine.store(s)!==a&&Alpine.store(s,a);else{let c=Alpine.store(s);for(let h=0;h<o.length-1;h++){let _=o[h];(!(_ in c)||typeof c[_]!="object")&&(c[_]={}),c=c[_]}let u=o[o.length-1];c[u]!==a&&(c[u]=a)}},l=n();Alpine.effect(()=>{let a=n();a!==l&&a!==void 0&&(l=a,this[e]!==a&&(this.__isSyncingFromStore=e,this[e]=a,this.$nextTick(()=>{this.__isSyncingFromStore===e&&(this.__isSyncingFromStore=null)})))}),this.$watch(e,a=>{this.__isSyncingFromStore!==e&&n()!==a&&(i(a),l=a)});let d=n();d!==void 0?(this[e]=d,l=d):(i(this[e]),l=this[e])})},__childComponents:{},__rootBind:{"@tetra:child-component-init"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(t.key&&(this.__childComponents[t.key]=t),t._parent=this)},"@tetra:child-component-destroy"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(delete this.__childComponents[t.key],e.detail.component._parent=null)}}}},makeServerMethods(e){let t={};return e.forEach(r=>{var s=async function(...o){return await p.callServerMethod(this,r.name,r.endpoint,o)};r.debounce?s=p.debounce(s,r.debounce,r.debounce_immediate):r.throttle&&(s=p.throttle(s,r.throttle,{leading:r.throttle_leading,trailing:r.throttle_trailing})),t[r.name]=s}),t},makeAlpineComponent(e,t,r,s){Alpine.data(e,o=>{let{init:n,destroy:i,...l}=t,d=p.jsonDecode(o);return{componentName:e,__initInner:n,__destroyInner:i,__serverMethods:r,__serverProperties:s,__serverStores:d==null?void 0:d.__serverStores,...d||{},...l,...p.makeServerMethods(r),...p.alpineComponentMixins()}})},getStateWithChildren(e){let t={};e.__serverProperties.forEach(s=>{t[s]=e[s]}),e.__serverStores&&(t.__serverStores=e.__serverStores);let r={encrypted:e.__state,data:t,children:[]};for(let s in e.__childComponents){let o=e.__childComponents[s];r.children.push(p.getStateWithChildren(o))}return r},loadScript(e){return new Promise((t,r)=>{let s=document.createElement("script");s.src=e,s.onload=t,s.onerror=r,document.head.appendChild(s)})},loadStyles(e){return new Promise((t,r)=>{let s=document.createElement("link");s.href=e,s.rel="stylesheet",s.type="text/css",s.onload=t,s.onerror=r,document.head.appendChild(s)})},getFilenameFromContentDisposition(e){if(!e)return null;let t=/filename\*=([^']*)'([^']*)'([^;]*)/i.exec(e);if(t)try{return decodeURIComponent(t[3])}catch(r){console.warn("Error decoding filename:",r)}return t=/filename=["']?([^"';\n]*)["']?/i.exec(e),t?t[1]:null},async handleServerMethodResponse(e,t){if(e.status===200){let r=e.headers.get("Content-Disposition");if(r!=null&&r.startsWith("attachment")){let u=document.createElement("a");u.href=URL.createObjectURL(await e.blob()),u.download=this.getFilenameFromContentDisposition(r),u.click(),u.remove();return}let s=await e.text(),o=p.jsonDecode(s),n=!1,i=null,l=[],d=[],a=[],c=[];if(o.protocol!=="tetra-1.0")throw new Error("Invalid or missing Tetra protocol in server response");if(n=o.success,o.payload&&(i=o.payload.result),o.metadata){l=o.metadata.js||[],d=o.metadata.styles||[],a=o.metadata.messages||[],c=o.metadata.callbacks||[];let u=c.find(h=>h.callback&&h.callback.length===1&&h.callback[0]==="_redirect");if(u&&u.args&&u.args.length>0){document.location=u.args[0];return}}if(!n&&o.error&&(console.error(`Tetra method error [${o.error.code}]: ${o.error.message}`),document.dispatchEvent(new CustomEvent("tetra:method-error",{detail:{component:t,error:o.error}}))),a&&a.forEach(u=>{t.$dispatch("tetra:new-message",u)}),n){let u=[];return l.forEach(h=>{document.querySelector(`script[src="${CSS.escape(h)}"]`)||u.push(p.loadScript(h))}),d.forEach(h=>{document.querySelector(`link[href="${CSS.escape(h)}"]`)||u.push(p.loadStyles(h))}),await Promise.all(u),c&&c.forEach(h=>{let _=t;h.callback.forEach((m,b)=>{b===h.callback.length-1?_[m](...h.args):_=_[m]})}),i}else throw o.error?new Error(`Error processing public method: ${o.error.message}`):new Error("Error processing public method")}else throw new Error(`Server responded with an error ${e.status} (${e.statusText})`)},async callServerMethod(e,t,r,s){let o=Math.random().toString(36).substring(2,15),n=p.getStateWithChildren(e);n.args=s||[];let i={protocol:"tetra-1.0",id:o,type:"call",payload:{component_id:e.$el.getAttribute("tetra-component-id"),method:t,args:n.args,state:n.data,encrypted_state:n.encrypted,children_state:n.children}},l={method:"POST",headers:{"T-Request":"true","T-Current-URL":document.location.href,"X-CSRFToken":window.__tetra_csrfToken},mode:"same-origin"},d=new FormData,a=!1;for(let[_,m]of Object.entries(n.data))m instanceof File&&(a=!0,i.payload.state[_]={},d.append(_,m));a?(d.append("tetra_payload",p.jsonEncode(i)),l.body=d):(l.body=p.jsonEncode(i),l.headers["Content-Type"]="application/json");let c=e.$event?e.$event.target:e.$el;e.$dispatch("tetra:before-request",{component:e,triggerEl:c,requestId:o});let u=await fetch(r,l);return e.$dispatch("tetra:after-request",{component:e,triggerEl:c,requestId:o}),await this.handleServerMethodResponse(u,e)},jsonReplacer(e,t){return t instanceof Date?{__type:"datetime",value:t.toISOString()}:t instanceof Set?{__type:"set",value:Array.from(t)}:t},jsonReviver(e,t){if(t&&typeof t=="object"&&t.__type){if(t.__type==="datetime")return new Date(t);if(t.__type==="set")return new Set(t)}return t},jsonEncode(e){return JSON.stringify(e,p.jsonReplacer)},jsonDecode(e){return JSON.parse(e,p.jsonReviver)},debounce(e,t,r){var s;return function(){var o=this,n=arguments,i=function(){s=null,r||e.apply(o,n)},l=r&&!s;clearTimeout(s),s=setTimeout(i,t),l&&e.apply(o,n)}},throttle(e,t,r){var s,o,n,i,l=0;r||(r={});var d=function(){l=r.leading===!1?0:Date.now(),s=null,i=e.apply(o,n),s||(o=n=null)},a=function(){var c=Date.now();!l&&r.leading===!1&&(l=c);var u=t-(c-l);return o=this,n=arguments,u<=0||u>t?(s&&(clearTimeout(s),s=null),l=c,i=e.apply(o,n),s||(o=n=null)):!s&&r.trailing!==!1&&(s=setTimeout(d,u)),i};return a.cancel=function(){clearTimeout(s),l=0,s=o=n=null},a}},f=p;window.Tetra=f;window.document.addEventListener("alpine:init",()=>{f.init()});})();
//# sourceMappingURL=tetra.min.js.map
