(()=>{var a={ws:null,pendingSubscriptions:new Map,init(){Alpine.magic("static",()=>a.$static),window.__tetra_useWebsockets&&this.ensureWebSocketConnection()},$static(){return e=>window.__tetra_staticRoot+e},ensureWebSocketConnection(){return(!this.ws||this.ws.readyState===WebSocket.CLOSED)&&(console.log("Connecting to Tetra WebSocket..."),this.ws=new WebSocket(`ws://${window.location.host}/ws/tetra/`),this.ws.onopen=()=>{console.log("Tetra WebSocket connected"),this.pendingSubscriptions.forEach((e,t)=>{this.ws.send(JSON.stringify(e))}),this.pendingSubscriptions.clear()},this.ws.onmessage=e=>{let t=JSON.parse(e.data);this.handleWebsocketMessage(t)},this.ws.onclose=()=>{console.log("Tetra WebSocket disconnected"),setTimeout(()=>{this.ensureWebSocketConnection()},3e3)},this.ws.onerror=e=>{console.error("Tetra WebSocket error:",e)}),this.ws},_get_component_by_id(e){let t=document.querySelector(`[tetra-component-id="${e}"]`);if(!t){console.error(`AlpineJs Component with ID ${e} not found.`);return}return Alpine.$data(t)},_get_components_by_subscribe_group(e){let t=document.querySelectorAll("[tetra-subscription]");return Array.from(t).filter(o=>o.getAttribute("tetra-subscription").split(",").map(i=>i.trim()).includes(e)).map(o=>Alpine.$data(o))},handleWebsocketMessage(e){let t=e.type;switch(t){case"subscription.response":this.handleSubscriptionResponse(e);break;case"notify":this.handleGroupNotify(e);break;case"component.update_data":this.handleComponentUpdateData(e);break;case"component.remove":this.handleComponentRemove(e);break;default:console.warn("Unknown WebSocket message type:",t,":",e)}},handleSubscriptionResponse(e){switch(e.status){case"subscribed":console.debug("Subscription to group",e.group,"successful."),document.dispatchEvent(new CustomEvent("tetra:component-subscribed",{detail:{component:this,group:e.group}}));break;case"unsubscribed":console.debug("Subscription to group",e.group,"redacted successfully."),document.dispatchEvent(new CustomEvent("tetra:component-unsubscribed",{detail:{component:this,group:e.group}}));break;case"error":console.error("Error subscribing component",e.component_id,"to group",e.group,":",e.message),document.dispatchEvent(new CustomEvent("tetra:component-subscription-error",{detail:{component:this,group:e.group,message:e.message}}));break;default:console.debug("Subscription response faulty:",e)}},handleGroupNotify(e){let{group:t,event_name:n,data:o}=e;document.dispatchEvent(new CustomEvent(`tetra:group:${t}`,{detail:{event_name:n,data:o,sender_id,group:t}})),document.dispatchEvent(new CustomEvent("tetra:group-message",{detail:{event_name:n,data:o,sender_id,group:t}}))},handleComponentUpdateData(e){let{type:t,group:n,data:o}=e;this._get_components_by_subscribe_group(n).forEach(r=>r._updateData(o))},handleComponentRemove(e){let{type:t,group:n,component_id:o}=e,s=this._get_component_by_id(o);s&&s._removeComponent?s._removeComponent():(s.remove(),console.debug("Element with ID ${component_id} not identified as Alpine component, just removed it anyway."))},sendWebSocketMessage(e){if(!this.ws){console.log("WebSocket is not connected. Cannot send message.");return}this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):(e.type==="subscribe"&&e.component_id&&this.pendingSubscriptions.set(e.component_id,e),this.ws.addEventListener("open",()=>{this.ws.send(JSON.stringify(e))},{once:!0}))},alpineComponentMixins(){return{init(){this.component_id=this.$el.getAttribute("tetra-component-id"),this.$dispatch("tetra:child-component-init",{component:this}),this.__initServerWatchers(),this.$el.hasAttribute("tetra-reactive")&&a.ensureWebSocketConnection();let e=this.$el.getAttribute("tetra-subscription");e&&this._subscribe(e),this.__initInner&&this.__initInner(),document.addEventListener("tetra:before-request",t=>{let n=t.target.getAttribute("tx-indicator");n?this.$el.querySelectorAll(n).forEach(o=>o.classList.add("tetra-request")):t.target.classList.add("tetra-request")}),document.addEventListener("tetra:after-request",t=>{let n=t.target.getAttribute("tx-indicator");n?this.$el.querySelectorAll(n).forEach(o=>o.classList.remove("tetra-request")):t.target.classList.remove("tetra-request")})},destroy(){this.$dispatch("tetra:child-component-destroy",{component:this}),this.__subscribedGroups&&this.__subscribedGroups.forEach(e=>{this._unsubscribe(e)}),this.__destroyInner&&this.__destroyInner()},_handleGroupEvent(e){let{event_name:t,data:n,sender_id:o,group:s}=e;o!==this.component_id&&this.$dispatch(`tetra:group-event:${t}`,{data:n,sender_id:o,group:s,component:this})},_updateHtml(e){Alpine.morph(this.$root,e,{updating(t,n,o,s){if(n.hasAttribute&&n.hasAttribute("x-data-maintain")&&t.hasAttribute&&t.hasAttribute("x-data"))n.setAttribute("x-data",t.getAttribute("x-data")),n.removeAttribute("x-data-maintain");else if(n.hasAttribute&&n.hasAttribute("x-data-update")&&t.hasAttribute&&t.hasAttribute("x-data")){let r=a.jsonDecode(n.getAttribute("x-data-update")),i=a.jsonDecode(n.getAttribute("x-data-update-old")),c=window.Alpine.$data(t);for(let d in r)i.hasOwnProperty(d)&&i[d]!==c[d]||(c[d]=r[d]);n.setAttribute("x-data",t.getAttribute("x-data")),n.removeAttribute("x-data-update")}},lookahead:!0}),this.$dispatch("tetra:component-updated",{component:this})},_updateData(e){for(let t in e)this[t]=e[t];this.$dispatch("tetra:component-data-updated",{component:this})},_setValueByName(e,t){let n=document.getElementsByName(e);for(let o=0;o<n.length;o++)n[o].value=t},_removeComponent(){this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.remove()},_replaceComponent(e){this.$dispatch("tetra:component-before-remove",{component:this}),this.$root.insertAdjacentHTML("afterend",e),this.$root.remove(),this.$dispatch("tetra:component-updated",{component:this})},_redirect(e){document.location=e},_dispatch(e,t){this.$dispatch(e,{_component:this,...t})},_pushUrl(e,t=!1){t?window.history.replaceState(null,"",e):window.history.pushState(null,"",e)},_updateSearchParam(e,t){let n=new URL(window.location);t?n.searchParams.set(e,t):n.searchParams.delete(e),window.history.pushState(null,"",n.toString())},_subscribe(e,t=!0){return this.__subscribedGroups||(this.__subscribedGroups=new Set),this.__subscribedGroups.add(e),a.sendWebSocketMessage({type:"subscribe",group:e,component_id:this.component_id,component_class:this.componentName,auto_update:t})},_unsubscribe(e){return this.__subscribedGroups&&this.__subscribedGroups.delete(e),a.sendWebSocketMessage({type:"unsubscribe",group:e,component_id:this.component_id})},_notifyGroup(e,t,n){return a.sendWebSocketMessage({type:"notify",group:e,event_name:t,data:n,sender_id:this.component_id})},__initServerWatchers(){this.__serverMethods.forEach(e=>{e.watch&&e.watch.forEach(t=>{this.$watch(t,async(n,o)=>{await this[e.name](n,o,t)})})})},__childComponents:{},__rootBind:{"@tetra:child-component-init"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(t.key&&(this.__childComponents[t.key]=t),t._parent=this)},"@tetra:child-component-destroy"(e){e.stopPropagation();let t=e.detail.component;t.key!==this.key&&(delete this.__childComponents[t.key],e.detail.component._parent=null)}}}},makeServerMethods(e){let t={};return e.forEach(n=>{var o=async function(...s){return await a.callServerMethod(this,n.name,n.endpoint,s)};n.debounce?o=a.debounce(o,n.debounce,n.debounce_immediate):n.throttle&&(o=a.throttle(o,n.throttle,{leading:n.throttle_leading,trailing:n.throttle_trailing})),t[n.name]=o}),t},makeAlpineComponent(e,t,n,o){Alpine.data(e,s=>{let{init:r,destroy:i,...c}=t,d=a.jsonDecode(s);return{componentName:e,__initInner:r,__destroyInner:i,__serverMethods:n,__serverProperties:o,...d||{},...c,...a.makeServerMethods(n),...a.alpineComponentMixins()}})},getStateWithChildren(e){let t={};e.__serverProperties.forEach(o=>{t[o]=e[o]});let n={encrypted:e.__state,data:t,children:[]};for(let o in e.__childComponents){let s=e.__childComponents[o];n.children.push(a.getStateWithChildren(s))}return n},loadScript(e){return new Promise((t,n)=>{let o=document.createElement("script");o.src=e,o.onload=t,o.onerror=n,document.head.appendChild(o)})},loadStyles(e){return new Promise((t,n)=>{let o=document.createElement("link");o.href=e,o.rel="stylesheet",o.type="text/css",o.onload=t,o.onerror=n,document.head.appendChild(o)})},getFilenameFromContentDisposition(e){if(!e)return null;let t=/filename\*=([^']*)'([^']*)'([^;]*)/i.exec(e);if(t)try{return decodeURIComponent(t[3])}catch(n){console.warn("Error decoding filename:",n)}return t=/filename=["']?([^"';\n]*)["']?/i.exec(e),t?t[1]:null},async handleServerMethodResponse(e,t){if(e.status===200){if(e.headers.get("T-Response")!=="true")throw new Error("Response is not a Tetra response. Please check the server implementation.");let n=a.jsonDecode(e.headers.get("T-Messages"));n&&n.forEach((r,i)=>{t.$dispatch("tetra:new-message",r)});let o=e.headers.get("Content-Disposition");if(o!=null&&o.startsWith("attachment")){let r=document.createElement("a");r.href=URL.createObjectURL(await e.blob()),r.download=this.getFilenameFromContentDisposition(o),r.click(),r.remove();return}let s=a.jsonDecode(await e.text());if(s.success){let r=[];return s.js.forEach(i=>{document.querySelector(`script[src="${CSS.escape(i)}"]`)||r.push(a.loadScript(i))}),s.styles.forEach(i=>{document.querySelector(`link[href="${CSS.escape(i)}"]`)||r.push(a.loadStyles(i))}),await Promise.all(r),s.callbacks&&s.callbacks.forEach(i=>{let c=t;i.callback.forEach((d,u)=>{u===i.callback.length-1?c[d](...i.args):(c=c[d],console.log(d,c))})}),s.result}else throw new Error("Error processing public method")}else throw new Error(`Server responded with an error ${e.status} (${e.statusText})`)},async callServerMethod(e,t,n,o){let s=a.getStateWithChildren(e);s.args=o||[];let r={method:"POST",headers:{"T-Request":"true","T-Current-URL":document.location.href,"X-CSRFToken":window.__tetra_csrfToken},mode:"same-origin"},i=new FormData,c=!1;for(let[u,p]of Object.entries(s.data))p instanceof File&&(c=!0,s.data[u]={},i.append(u,p));c?(i.append("component_state",a.jsonEncode(s)),r.body=i):(r.body=a.jsonEncode(s),r.headers["Content-Type"]="application/json"),e.$dispatch("tetra:before-request",{component:this});let d=await fetch(n,r);return e.$dispatch("tetra:after-request",{component:this}),await this.handleServerMethodResponse(d,e)},jsonReplacer(e,t){return t instanceof Date?{__type:"datetime",value:t.toISOString()}:t instanceof Set?{__type:"set",value:Array.from(t)}:t},jsonReviver(e,t){if(t&&typeof t=="object"&&t.__type){if(t.__type==="datetime")return new Date(t);if(t.__type==="set")return new Set(t)}return t},jsonEncode(e){return JSON.stringify(e,a.jsonReplacer)},jsonDecode(e){return JSON.parse(e,a.jsonReviver)},debounce(e,t,n){var o;return function(){var s=this,r=arguments,i=function(){o=null,n||e.apply(s,r)},c=n&&!o;clearTimeout(o),o=setTimeout(i,t),c&&e.apply(s,r)}},throttle(e,t,n){var o,s,r,i,c=0;n||(n={});var d=function(){c=n.leading===!1?0:now(),o=null,i=e.apply(s,r),o||(s=r=null)},u=function(){var p=new Date().getTime();!c&&n.leading===!1&&(c=p);var l=t-(p-c);return s=this,r=arguments,l<=0||l>t?(o&&(clearTimeout(o),o=null),c=p,i=e.apply(s,r),o||(s=r=null)):!o&&n.trailing!==!1&&(o=setTimeout(d,l)),i};return u.cancel=function(){clearTimeout(o),c=0,o=s=r=null},u}},h=a;window.Tetra=h;window.document.addEventListener("alpine:init",()=>{h.init()});})();
//# sourceMappingURL=tetra.min.js.map
